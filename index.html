<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gully Cricket Live Scorer</title>
    <link rel="icon" href="https://mgcub.ac.in/images/rotate.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        /* Updated Ball Design */
        .ball-dot { 
            @apply min-w-[36px] h-9 rounded-lg flex items-center justify-center text-sm font-black border shadow-sm transition-all transform hover:-translate-y-0.5; 
        }
        
        .bg-brand-primary { background-color: #F7631B; }
        .text-brand-primary { color: #F7631B; }
        .border-brand-primary { border-color: #F7631B; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #F7631B; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .break-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        
        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(20px); opacity: 0; transition: all 0.3s ease-in; }

        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }

        /* 3D Coin Animation */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative">
        
        <!-- Header -->
        <header class="bg-brand-primary text-white p-4 shadow-md sticky top-0 z-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="global-back-btn" onclick="handleGlobalBack()" class="hidden p-1 hover:bg-orange-600 rounded-full transition-colors mr-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <img src="https://mgcub.ac.in/images/rotate.png" alt="Logo" class="h-10 w-10 object-contain bg-white rounded-full p-1">
                    <div>
                        <h1 class="text-lg font-bold tracking-wider leading-tight uppercase">Gully Premier League</h1>
                        <div class="flex items-center gap-2">
                            <span id="sync-status" class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                            <p id="header-subtitle" class="text-[9px] text-orange-100 uppercase tracking-widest">Live Cloud Sync Active</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Setup Screen -->
        <div id="setup-screen" class="p-6 flex-grow flex flex-col">
            <div class="text-center mb-6">
                <img src="https://c8.alamy.com/comp/2C0RN9G/cricket-bat-and-ball-badge-illustration-2C0RN9G.jpg" alt="Cricket Badge" class="mx-auto h-24 w-24 mb-2 object-contain rounded-full shadow-sm">
                <h2 class="text-lg font-semibold text-gray-700">Tournament Setup</h2>
            </div>
            
            <div class="space-y-4 flex-grow">
                <div id="resume-container" class="hidden animate-bounce">
                    <button onclick="resumeMatch()" class="w-full bg-green-50 border-2 border-green-500 text-green-700 p-4 rounded-xl flex items-center justify-between shadow-sm">
                        <div class="text-left">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-green-600">Active Match Found</p>
                            <p class="font-black text-sm" id="resume-match-info">Loading...</p>
                        </div>
                        <div class="flex items-center gap-1 font-bold text-xs uppercase">
                            Resume <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                        </div>
                    </button>
                    <div class="mt-2 h-[1px] bg-gray-200"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">üèè Batting Team</label>
                    <select id="batting-team-select" onchange="toggleCustomTeam('batting')" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                        <option value="B.Tech">B.Tech</option>
                        <option value="MBA">MBA</option>
                        <option value="B.Com">B.Com</option>
                        <option value="custom" class="text-brand-primary font-bold">+ Custom Team Name</option>
                    </select>
                    <input type="text" id="batting-team-input" class="hidden w-full p-3 mt-2 border rounded-lg bg-white focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold shadow-sm" placeholder="Enter Team Name">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">‚öæ Bowling Team</label>
                    <select id="bowling-team-select" onchange="toggleCustomTeam('bowling')" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                        <option value="MBA">MBA</option>
                        <option value="B.Tech">B.Tech</option>
                        <option value="B.Com">B.Com</option>
                        <option value="custom" class="text-brand-primary font-bold">+ Custom Team Name</option>
                    </select>
                    <input type="text" id="bowling-team-input" class="hidden w-full p-3 mt-2 border rounded-lg bg-white focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold shadow-sm" placeholder="Enter Team Name">
                </div>

                <div class="flex justify-end -mt-2">
                    <button onclick="openTossModal()" class="text-xs font-bold text-[#F7631B] flex items-center gap-1 border border-orange-200 px-3 py-1.5 rounded-full hover:bg-orange-50 transition-colors shadow-sm">
                        <span>ü™ô</span> Digital Toss
                    </button>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">Overs</label>
                        <input type="number" id="max-overs" value="5" min="1" max="50" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">Players</label>
                        <input type="number" id="player-count" value="11" min="2" max="11" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                    </div>
                </div>

                <button onclick="startMatch()" class="w-full bg-brand-primary hover:opacity-90 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 uppercase tracking-widest mt-2">
                    Start New Match
                </button>

                <div class="pt-2">
                    <button onclick="showHistory()" class="w-full bg-white text-gray-700 font-bold py-4 rounded-xl border-2 border-gray-200 transition-all active:scale-95 uppercase text-xs flex items-center justify-center gap-3 shadow-sm hover:border-orange-200">
                        <span class="relative flex h-3 w-3">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                        </span>
                        View Live Scores & History
                    </button>
                </div>
            </div>
        </div>

        <!-- Initial Players Modal -->
        <div id="initial-players-modal" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 modal-enter">
                <h3 class="text-lg font-black text-gray-800 mb-4 uppercase">Match Starters</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Striker</label>
                        <input type="text" id="init-striker" class="w-full p-3 border rounded-lg bg-gray-50 font-bold focus:ring-2 focus:ring-[#F7631B] outline-none" placeholder="Enter Name">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Non-Striker</label>
                        <input type="text" id="init-non-striker" class="w-full p-3 border rounded-lg bg-gray-50 font-bold focus:ring-2 focus:ring-[#F7631B] outline-none" placeholder="Enter Name">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Opening Bowler</label>
                        <input type="text" id="init-bowler" class="w-full p-3 border rounded-lg bg-gray-50 font-bold focus:ring-2 focus:ring-[#F7631B] outline-none" placeholder="Enter Name">
                    </div>
                </div>
                <button onclick="submitInitialPlayers()" class="w-full mt-6 bg-brand-primary text-white font-bold py-3 rounded-xl shadow-lg uppercase tracking-widest">Start Scoring</button>
            </div>
        </div>

        <!-- New Batsman Modal -->
        <div id="new-batsman-modal" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 modal-enter">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">‚òùÔ∏è</div>
                    <h3 class="text-lg font-black text-gray-800 uppercase">Wicket Fall!</h3>
                    <p class="text-sm text-gray-500">Who is the new batsman?</p>
                </div>
                <input type="text" id="new-batsman-name" class="w-full p-3 border rounded-lg bg-gray-50 font-bold focus:ring-2 focus:ring-[#F7631B] outline-none mb-4" placeholder="Enter Name (or leave blank)">
                <button onclick="submitNewBatsman()" class="w-full bg-brand-primary text-white font-bold py-3 rounded-xl shadow-lg uppercase tracking-widest">Update Striker</button>
            </div>
        </div>

        <!-- Next Bowler Modal -->
        <div id="next-bowler-modal" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 modal-enter">
                <div class="text-center mb-4">
                    <div class="text-4xl mb-2">üèÅ</div>
                    <h3 class="text-lg font-black text-gray-800 uppercase">Over Complete</h3>
                    <p class="text-sm text-gray-500">Select bowler for next over</p>
                </div>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase">Select Existing</label>
                        <select id="existing-bowler-select" class="w-full p-3 border rounded-lg bg-gray-50 font-bold outline-none mb-2" onchange="document.getElementById('new-bowler-name').value = ''">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="text-center text-xs font-bold text-gray-400">- OR -</div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 uppercase">New Bowler</label>
                        <input type="text" id="new-bowler-name" class="w-full p-3 border rounded-lg bg-gray-50 font-bold focus:ring-2 focus:ring-[#F7631B] outline-none" placeholder="Enter Name (or leave blank)" oninput="document.getElementById('existing-bowler-select').value = ''">
                    </div>
                </div>

                <button onclick="submitNextBowler()" class="w-full mt-6 bg-brand-primary text-white font-bold py-3 rounded-xl shadow-lg uppercase tracking-widest">Start Over</button>
            </div>
        </div>

        <!-- No Ball Run Selection Modal -->
        <div id="nb-runs-modal" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="document.getElementById('nb-runs-modal').classList.add('hidden')"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 modal-enter text-center">
                <h3 class="text-lg font-black text-gray-800 mb-2 uppercase">No Ball</h3>
                <p class="text-sm text-gray-500 mb-4">Runs scored off the bat?</p>
                <div class="grid grid-cols-3 gap-3">
                    <button onclick="confirmNoBall(0)" class="p-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200">0</button>
                    <button onclick="confirmNoBall(1)" class="p-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200">1</button>
                    <button onclick="confirmNoBall(2)" class="p-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200">2</button>
                    <button onclick="confirmNoBall(3)" class="p-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200">3</button>
                    <button onclick="confirmNoBall(4)" class="p-3 bg-orange-100 text-orange-600 rounded-xl font-bold hover:bg-orange-200">4</button>
                    <button onclick="confirmNoBall(6)" class="p-3 bg-orange-600 text-white rounded-xl font-bold hover:bg-orange-700">6</button>
                </div>
                <button onclick="document.getElementById('nb-runs-modal').classList.add('hidden')" class="mt-4 text-xs font-bold text-gray-400 uppercase hover:text-gray-600">Cancel</button>
            </div>
        </div>

        <!-- Toss Modal -->
        <div id="toss-modal" class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeTossModal()"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center overflow-hidden modal-enter">
                <button onclick="closeTossModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <h3 class="text-xl font-black text-gray-800 uppercase tracking-tight mb-6">Coin Toss</h3>
                
                <!-- Coin Container -->
                <div class="h-32 mb-8 flex justify-center perspective-1000">
                     <div id="coin" class="w-32 h-32 relative transform-style-3d transition-transform duration-[3000ms]">
                        <div class="absolute inset-0 rounded-full bg-yellow-400 border-4 border-yellow-600 flex items-center justify-center text-3xl font-bold text-yellow-800 shadow-inner backface-hidden">H</div>
                        <div class="absolute inset-0 rounded-full bg-gray-200 border-4 border-gray-400 flex items-center justify-center text-3xl font-bold text-gray-700 shadow-inner backface-hidden rotate-y-180">T</div>
                     </div>
                </div>

                <!-- Step 1: Flip -->
                <div id="toss-controls">
                    <button onclick="flipCoin()" class="w-full bg-brand-primary text-white font-bold py-3 rounded-xl shadow-lg uppercase tracking-widest hover:opacity-90">Flip Coin</button>
                </div>
                
                <!-- Step 2: Winner -->
                <div id="toss-winner-select" class="hidden space-y-3">
                    <p class="text-sm text-gray-500 font-bold uppercase">Who won the toss?</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btn-toss-team1" onclick="selectTossWinner(0)" class="p-2 border-2 border-gray-200 rounded-lg font-bold text-sm truncate hover:border-orange-400 transition-colors"></button>
                        <button id="btn-toss-team2" onclick="selectTossWinner(1)" class="p-2 border-2 border-gray-200 rounded-lg font-bold text-sm truncate hover:border-orange-400 transition-colors"></button>
                    </div>
                </div>

                <!-- Step 3: Decision -->
                <div id="toss-decision-select" class="hidden space-y-3 mt-4">
                    <p class="text-sm text-gray-500 font-bold uppercase">What did they choose?</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="finalizeToss('bat')" class="p-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-xl font-bold text-sm hover:bg-blue-100 transition-colors">üèè Bat</button>
                        <button onclick="finalizeToss('bowl')" class="p-3 bg-green-50 text-green-600 border border-green-200 rounded-xl font-bold text-sm hover:bg-green-100 transition-colors">‚öæ Bowl</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="hidden p-6 flex-grow overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">Tournament Logs</h2>
                <div id="history-sync-indicator" class="hidden"><div class="loader !w-4 !h-4"></div></div>
            </div>

            <!-- Tabs -->
            <div class="flex p-1 bg-gray-100 rounded-xl mb-6 shadow-inner">
                <button id="tab-live" onclick="switchLogTab('live')" class="flex-1 flex items-center justify-center gap-2 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all shadow-sm bg-white text-red-600 border border-red-100">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                    </span>
                    Live Now
                </button>
                <button id="tab-past" onclick="switchLogTab('past')" class="flex-1 flex items-center justify-center gap-2 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all text-gray-500 hover:bg-gray-200 border border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Past Matches
                </button>
            </div>

            <div id="history-list" class="space-y-4 pb-10">
                <div class="text-center text-gray-500 py-10">Connecting to Tournament Stream...</div>
            </div>
        </div>

        <!-- Viewer Screen -->
        <div id="viewer-screen" class="hidden flex-grow flex flex-col relative overflow-y-auto">
             <div class="bg-gray-900 text-white p-4 text-center sticky top-0 z-10 shadow-lg">
                <!-- Header with Teams, Target and Share -->
                <div class="flex justify-between items-center mb-4">
                    <span id="v-display-teams" class="text-xs font-bold text-gray-400 uppercase tracking-widest text-left">Loading...</span>
                    <div class="flex items-center gap-2">
                         <span id="v-display-target" class="text-xs text-[#F7631B] font-bold hidden uppercase whitespace-nowrap">TARGET: 0</span>
                         <button onclick="shareCurrentMatch()" class="p-2 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors shrink-0" title="Share Match Link">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                             </svg>
                         </button>
                    </div>
                </div>

                <div id="v-start-time-label" class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest font-medium">Started: --:--</div>
                
                <div class="text-5xl font-black mb-1">
                    <span id="v-runs">0</span>/<span id="v-wickets">0</span>
                </div>
                <div class="text-lg text-gray-400 font-bold">
                    Overs: <span id="v-overs">0.0</span> / <span id="v-limit">5</span>
                </div>

                <!-- Viewer Player Bar -->
                <div class="mt-4 bg-gray-800 rounded-lg p-3 text-xs flex justify-between items-center border border-gray-700 shadow-inner">
                    <div class="flex flex-col text-left gap-2 w-1/2">
                        <div class="font-bold text-white flex items-center gap-1 overflow-hidden whitespace-nowrap">
                            üèè <span id="v-label-striker" class="truncate">Striker</span> <span class="text-[#F7631B] text-[10px] ml-1">*</span>
                        </div>
                        <div class="text-gray-400 flex items-center gap-1 overflow-hidden whitespace-nowrap">
                            üèÉ <span id="v-label-nonStriker" class="truncate">Non-Striker</span>
                        </div>
                    </div>
                    <div class="w-1/2 text-right">
                        <div class="text-[9px] uppercase text-gray-500 tracking-wider mb-0.5">Bowling</div>
                        <div class="font-bold text-white flex items-center justify-end gap-1 overflow-hidden whitespace-nowrap">
                            <span id="v-label-bowler" class="truncate">Bowler</span> ‚öæ
                        </div>
                    </div>
                </div>

                <div class="mt-4 flex justify-around text-xs border-t border-gray-800 pt-4">
                    <div class="text-center"><p class="text-gray-500 uppercase font-bold">Run Rate</p><p class="text-lg font-bold" id="v-crr">0.00</p></div>
                    <div id="v-rrr-box" class="text-center hidden"><p class="text-gray-500 uppercase font-bold">Req Rate</p><p class="text-lg font-bold text-[#F7631B]" id="v-rrr">0.00</p></div>
                </div>
            </div>

            <div id="v-break-overlay" class="hidden absolute inset-0 z-10 break-overlay flex flex-col items-center justify-center text-white text-center p-6">
                <div id="v-overlay-icon" class="text-4xl mb-4">‚òï</div>
                <h3 id="v-overlay-title" class="text-2xl font-black uppercase tracking-tighter">Match on Break</h3>
                <p id="v-overlay-desc" class="text-sm text-gray-300 mt-2">Waiting for teams to resume play...</p>
            </div>

            <!-- Viewer Over History -->
            <div class="p-4 bg-white border-b flex items-center gap-3 overflow-x-auto shadow-sm sticky top-[300px] z-0">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest shrink-0">This Over</span>
                <div id="v-over-history" class="flex gap-2 pb-1"></div>
            </div>

            <!-- Detailed Scorecard Section -->
            <div id="v-full-scorecard" class="p-4 space-y-4 bg-gray-50 pb-20">
                <!-- Content Injected via JS -->
            </div>

            <div class="p-4 flex-grow flex flex-col items-center justify-center text-center space-y-4">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center"><span class="w-3 h-3 bg-green-500 rounded-full animate-ping"></span></div>
                <p class="text-gray-500 font-medium">Watching Live Updates...</p>
                <button onclick="stopWatching()" class="mt-6 px-6 py-2 border border-gray-300 rounded-full text-sm text-gray-600 font-bold hover:bg-gray-50 shadow-sm uppercase">Back to Logs</button>
            </div>
        </div>

        <!-- Scoring Screen -->
        <div id="scoring-screen" class="hidden flex-grow flex flex-col relative">
            <div class="bg-gray-900 text-white p-4 text-center">
                <!-- Header with Teams, Target and Share -->
                <div class="flex justify-between items-center mb-4">
                    <span id="display-teams" class="text-xs font-bold text-gray-400 uppercase tracking-widest text-left">Loading...</span>
                    <div class="flex items-center gap-2">
                         <span id="display-target" class="text-xs text-[#F7631B] font-bold hidden uppercase whitespace-nowrap">TARGET: 0</span>
                         <button onclick="shareCurrentMatch()" class="p-2 bg-gray-800 hover:bg-gray-700 rounded-full text-gray-300 transition-colors shrink-0" title="Share Match Link">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                             </svg>
                         </button>
                    </div>
                </div>

                <div id="start-time-label" class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest font-medium">Started: --:--</div>
                <div class="text-5xl font-black mb-1"><span id="runs">0</span>/<span id="wickets">0</span></div>
                <div class="text-lg text-gray-400 font-bold">Overs: <span id="overs">0.0</span> / <span id="limit">5</span></div>
                
                <!-- Player Control Bar -->
                <div class="mt-4 bg-gray-800 rounded-lg p-2 text-xs flex justify-between items-center border border-gray-700">
                    <div class="flex flex-col text-left gap-2 flex-1 w-1/2">
                        <div onclick="openPlayerModal('striker')" class="cursor-pointer font-bold hover:text-[#F7631B] transition-colors flex items-center gap-1 group overflow-hidden whitespace-nowrap">
                            üèè <span id="label-striker" class="border-b border-dotted border-gray-600 truncate">Striker</span> <span class="text-[#F7631B] ml-1">*</span>
                        </div>
                        <div onclick="openPlayerModal('nonStriker')" class="cursor-pointer text-gray-400 hover:text-white transition-colors flex items-center gap-1 group overflow-hidden whitespace-nowrap">
                            üèÉ <span id="label-nonStriker" class="border-b border-dotted border-gray-600 truncate">Non-Striker</span>
                        </div>
                    </div>
                    
                    <button onclick="rotateStrike()" class="mx-2 p-2 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-sm active:scale-95 transition-all shrink-0" title="Rotate Strike">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </button>

                    <div class="flex-1 text-right w-1/2">
                        <div class="text-[9px] uppercase text-gray-500 tracking-wider mb-1">Bowling</div>
                        <div onclick="openPlayerModal('bowler')" class="cursor-pointer font-bold hover:text-[#F7631B] transition-colors flex items-center justify-end gap-1 overflow-hidden whitespace-nowrap">
                            <span id="label-bowler" class="border-b border-dotted border-gray-600 truncate">Bowler</span> ‚öæ
                        </div>
                    </div>
                </div>

                <!-- Updated Run Rate Display -->
                <div class="mt-4 flex justify-around text-xs border-t border-gray-800 pt-4">
                    <div class="text-center">
                        <p class="text-gray-500 uppercase font-bold">Run Rate</p>
                        <p class="text-lg font-bold" id="crr">0.00</p>
                    </div>
                    <div id="rrr-container" class="text-center hidden">
                        <p class="text-gray-500 uppercase font-bold">Req Rate</p>
                        <p class="text-lg font-bold text-[#F7631B]" id="rrr">0.00</p>
                    </div>
                </div>
            </div>

            <div id="break-overlay" class="hidden absolute inset-0 z-20 break-overlay flex flex-col items-center justify-center text-white text-center p-6">
                <div class="text-5xl mb-4">‚è∏Ô∏è</div>
                <h3 class="text-2xl font-black uppercase tracking-tighter">Match Paused</h3>
                <p class="text-sm text-gray-300 mt-2 mb-8">Scoring is disabled during break.</p>
                <div class="flex flex-col gap-3 w-full max-w-[200px]">
                    <button onclick="toggleBreak()" class="w-full bg-brand-primary text-white font-bold py-4 rounded-xl shadow-xl uppercase tracking-widest animate-pulse">
                        Resume Play
                    </button>
                    <button onclick="abandonMatch()" class="w-full bg-gray-700 text-gray-300 font-bold py-3 rounded-xl uppercase text-xs">
                        Abandon Match
                    </button>
                </div>
            </div>

            <!-- Scoring Over History -->
            <div class="p-4 bg-white border-b flex items-center gap-3 overflow-x-auto shadow-sm">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest shrink-0">This Over</span>
                <div id="over-history" class="flex gap-2 pb-1"></div>
            </div>

            <div class="p-4 grid grid-cols-4 gap-3 bg-white flex-grow">
                <button onclick="addScore(0)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">0</button>
                <button onclick="addScore(1)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">1</button>
                <button onclick="addScore(2)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">2</button>
                <button onclick="addScore(3)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">3</button>
                <button onclick="addScore(4)" class="col-span-2 bg-orange-50 text-[#F7631B] border-b-4 border-orange-200 hover:bg-orange-100 h-16 rounded-lg font-black text-2xl transition-all">4</button>
                <button onclick="addScore(6)" class="col-span-2 bg-[#F7631B] text-white hover:opacity-90 h-16 rounded-lg font-black text-2xl border-b-4 border-orange-800 transition-all">6</button>
                <button onclick="addExtra('WD')" class="col-span-2 bg-gray-50 text-gray-700 hover:bg-gray-100 h-16 rounded-lg font-bold border-b-4 border-gray-200 text-lg">WIDE (+1)</button>
                <button onclick="addExtra('NB')" class="col-span-2 bg-gray-50 text-gray-700 hover:bg-gray-100 h-16 rounded-lg font-bold border-b-4 border-gray-200 text-lg">NO BALL (+1)</button>
                <button onclick="addWicket()" class="col-span-4 bg-red-600 text-white hover:bg-red-700 h-16 rounded-lg font-black text-xl shadow-lg uppercase tracking-widest active:scale-95 transition-all">Wicket!</button>
            </div>
            <div class="p-4 bg-gray-50 flex items-center gap-2">
                <button onclick="undoLast()" class="flex-1 py-3 text-[10px] font-bold text-gray-500 border rounded-lg bg-white hover:bg-gray-100 uppercase transition-all shadow-sm">Undo</button>
                <button onclick="toggleBreak()" class="flex-1 py-3 text-[10px] font-bold text-blue-600 border border-blue-100 rounded-lg bg-white hover:bg-blue-50 uppercase transition-all shadow-sm">Break</button>
                <button onclick="redoLast()" class="flex-1 py-3 text-[10px] font-bold text-[#F7631B] border border-orange-100 rounded-lg bg-white hover:bg-orange-50 uppercase transition-all shadow-sm">Redo</button>
                <div id="save-loader" class="hidden shrink-0"><div class="loader"></div></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden p-8 text-center flex-grow flex flex-col justify-center">
            <div id="result-emoji" class="text-6xl mb-4">üèÜ</div>
            <h2 id="result-header" class="text-2xl font-black text-gray-800 mb-2 uppercase">Match Finished!</h2>
            <p id="winner-text" class="text-xl font-bold text-[#F7631B] mb-6"></p>
            <div id="final-stats" class="bg-gray-100 p-4 rounded-lg mb-4 text-left space-y-2 text-sm"></div>
            
            <button onclick="shareCurrentMatch()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold uppercase shadow-lg transition-transform active:scale-95 mb-3 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>
                Share Result
            </button>
            
            <button onclick="location.reload()" class="w-full bg-brand-primary text-white py-4 rounded-xl font-bold uppercase shadow-lg transition-transform active:scale-95">New Match</button>
        </div>

        <!-- Custom Confirmation Modal -->
        <div id="confirm-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4">
            <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"></div>
            <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 animate-in fade-in zoom-in duration-200">
                <div class="p-6 text-center">
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100 mb-4">
                        <svg class="h-6 w-6 text-[#F7631B]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Confirmation Required</h3>
                    <p id="confirm-msg" class="text-sm text-gray-500 mb-6">Are you sure?</p>
                    <div class="flex gap-3 justify-center">
                        <button id="confirm-cancel-btn" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 font-bold rounded-xl hover:bg-gray-200 transition-colors">Cancel</button>
                        <button id="confirm-yes-btn" class="flex-1 px-4 py-2 bg-[#F7631B] text-white font-bold rounded-xl hover:bg-orange-600 transition-colors shadow-lg shadow-orange-200">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Player Edit Modal -->
        <div id="player-modal" class="hidden fixed inset-0 z-[85] flex items-center justify-center p-4">
             <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="document.getElementById('player-modal').classList.add('hidden')"></div>
             <div class="relative bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden p-6 modal-enter">
                  <h3 id="player-modal-title" class="text-lg font-black uppercase text-gray-800 mb-4">Update Player</h3>
                  <input type="text" id="player-name-input" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-bold mb-4" placeholder="Enter Name">
                  <div class="flex gap-3">
                      <button onclick="document.getElementById('player-modal').classList.add('hidden')" class="flex-1 py-3 text-gray-500 font-bold bg-gray-100 rounded-xl hover:bg-gray-200">Cancel</button>
                      <button onclick="savePlayerName()" class="flex-1 py-3 text-white font-bold bg-brand-primary rounded-xl hover:opacity-90 shadow-lg">Save</button>
                  </div>
             </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs px-4 pointer-events-none"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBFBAcdUrHyfWGZEjxi0d1JhGHskqBKD3I",
            authDomain: "cricket-17e2d.firebaseapp.com",
            databaseURL: "https://cricket-17e2d-default-rtdb.firebaseio.com",
            projectId: "cricket-17e2d",
            storageBucket: "cricket-17e2d.firebasestorage.app",
            messagingSenderId: "346710609466",
            appId: "1:346710609466:web:a7f4d214c999767474af03"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "cricket-mgcub-v1"; 

        let user = null;
        let currentMatchId = null;
        let activeViewerMatchId = null; // Track viewer match separately
        let viewerMatchData = null; // Track viewer data for sharing
        let unsubscribeMatch = null;
        let unsubscribeHistory = null; 
        let activeMatchData = null; 
        let tossWinnerIdx = null; // 0 for team 1, 1 for team 2
        let team1Name = "", team2Name = "";
        let currentEditRole = null;
        
        // History State
        let currentLogTab = 'live';
        let allMatchesCache = [];

        let match = {
            battingTeam: "", bowlingTeam: "", maxOvers: 5, playerCount: 11,
            innings: 1, target: null, runs: 0, wickets: 0,
            balls: 0, history: [], redoStack: [], overHistory: [],
            startTime: null, endTime: null, isOnBreak: false,
            isAbandoned: false,
            result: null,
            striker: "Striker", nonStriker: "Non-Striker", bowler: "Bowler",
            playerStats: {}, // { "PlayerName": { runs: 0, balls: 0, wickets: 0, runsConceded: 0, ballsBowled: 0, isOut: false } }
            bowlersList: [] // Track list of bowlers
        };

        // --- Toast System ---
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                error: 'bg-red-600',
                success: 'bg-green-600',
                info: 'bg-gray-800',
                warning: 'bg-orange-500'
            };

            toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-2xl text-xs font-bold flex items-center justify-center text-center pointer-events-auto toast-enter`;
            toast.innerText = message;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('toast-active'), 10);
            
            setTimeout(() => {
                toast.classList.replace('toast-active', 'toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        };

        // --- Confirmation Modal System ---
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMsg = document.getElementById('confirm-msg');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        let confirmResolve = null;

        window.showConfirm = function(message) {
            confirmMsg.innerText = message;
            confirmModal.classList.remove('hidden');
            return new Promise((resolve) => {
                confirmResolve = resolve;
            });
        };

        confirmYesBtn.onclick = () => {
            confirmModal.classList.add('hidden');
            if(confirmResolve) confirmResolve(true);
        };

        confirmCancelBtn.onclick = () => {
            confirmModal.classList.add('hidden');
            if(confirmResolve) confirmResolve(false);
        };

        // --- Stats Helper ---
        function getStats(name, team) {
            if (!match.playerStats[name]) {
                match.playerStats[name] = { runs: 0, balls: 0, wickets: 0, runsConceded: 0, ballsBowled: 0, team: team || '' };
            }
            if (team && !match.playerStats[name].team) match.playerStats[name].team = team;
            return match.playerStats[name];
        }

        // --- Player Edit System ---
        window.openPlayerModal = function(role) {
            currentEditRole = role;
            const titleMap = { 'striker': "Update Striker", 'nonStriker': "Update Non-Striker", 'bowler': "Update Bowler" };
            document.getElementById('player-modal-title').innerText = titleMap[role];
            document.getElementById('player-name-input').value = match[role];
            
            const modal = document.getElementById('player-modal');
            modal.classList.remove('hidden');
            modal.querySelector('.relative').classList.remove('modal-active');
            modal.querySelector('.relative').classList.add('modal-enter');
            setTimeout(() => {
                modal.querySelector('.relative').classList.remove('modal-enter');
                modal.querySelector('.relative').classList.add('modal-active');
                document.getElementById('player-name-input').focus();
            }, 10);
        };

        window.savePlayerName = async function() {
            const name = document.getElementById('player-name-input').value.trim();
            if(name && currentEditRole) {
                match[currentEditRole] = name;
                document.getElementById('player-modal').classList.add('hidden');
                updateDisplay();
                await syncToCloud();
            } else {
                showToast("Name cannot be empty", "error");
            }
        };

        window.submitInitialPlayers = async function() {
            let striker = document.getElementById('init-striker').value.trim();
            let nonStriker = document.getElementById('init-non-striker').value.trim();
            let bowler = document.getElementById('init-bowler').value.trim();

            if(!striker) striker = `${match.battingTeam} Batter 1`;
            if(!nonStriker) nonStriker = `${match.battingTeam} Batter 2`;
            if(!bowler) bowler = `${match.bowlingTeam} Bowler 1`;

            match.striker = striker;
            match.nonStriker = nonStriker;
            match.bowler = bowler;
            match.bowlersList = [bowler]; // Init bowler list

            document.getElementById('initial-players-modal').classList.add('hidden');
            scoringScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            resumeContainer.classList.add('hidden');
            
            updateDisplay();
            await syncToCloud();
            showToast("Match Started!", "success");
        };

        window.submitNewBatsman = async function() {
            let name = document.getElementById('new-batsman-name').value.trim();
            if(!name) {
                // Wicket 1 down = 2 batsmen were on crease (1 & 2). New one is 3.
                // Wicket count is updated BEFORE this modal.
                // If 1 wicket, Batsman 3. If 2 wickets, Batsman 4.
                name = `${match.battingTeam} Batter ${match.wickets + 2}`;
            }
            match.striker = name; // Assuming incoming batsman takes strike
            document.getElementById('new-batsman-modal').classList.add('hidden');
            document.getElementById('new-batsman-name').value = '';
            updateDisplay();
            await syncToCloud();
        };

        window.submitNextBowler = async function() {
            const existing = document.getElementById('existing-bowler-select').value;
            let newName = document.getElementById('new-bowler-name').value.trim();
            
            let finalBowler = "";
            if(newName) {
                finalBowler = newName;
                if(!match.bowlersList.includes(newName)) match.bowlersList.push(newName);
            } else if (existing) {
                finalBowler = existing;
            } else {
                finalBowler = `${match.bowlingTeam} Bowler ${match.bowlersList.length + 1}`;
                match.bowlersList.push(finalBowler);
            }

            match.bowler = finalBowler;
            document.getElementById('next-bowler-modal').classList.add('hidden');
            document.getElementById('new-bowler-name').value = '';
            document.getElementById('existing-bowler-select').value = '';
            
            updateDisplay();
            await syncToCloud();
            showToast("New Over Started", "info");
        };

        window.confirmNoBall = async function(batRuns) {
            document.getElementById('nb-runs-modal').classList.add('hidden');
            saveState();
            
            // Logic: 1 run for NB penalty + batRuns
            const totalRuns = 1 + batRuns;
            match.runs += totalRuns;
            
            // Notation: "NB" if 0, "NB+4" etc.
            const notation = batRuns > 0 ? `NB+${batRuns}` : 'NB';
            match.overHistory.push(notation);
            
            // Stats - Bowler
            const bStats = getStats(match.bowler, match.bowlingTeam);
            bStats.runsConceded += totalRuns;
            // Note: ballsBowled does NOT increment for NB (illegal delivery)
            
            // Stats - Striker
            const sStats = getStats(match.striker, match.battingTeam);
            sStats.runs += batRuns;
            sStats.balls += 1; // Count NB as ball faced for batsman stats
            
            // Rotate strike if runs off bat is odd
            if (batRuns % 2 !== 0) {
                const temp = match.striker;
                match.striker = match.nonStriker;
                match.nonStriker = temp;
            }
            
            checkInningsStatus(); 
            updateDisplay(); 
            await syncToCloud();
            showToast(`No Ball + ${batRuns} runs recorded`, "success");
        };

        window.rotateStrike = async function() {
            const temp = match.striker;
            match.striker = match.nonStriker;
            match.nonStriker = temp;
            updateDisplay();
            await syncToCloud();
            showToast("Strike Rotated", "info");
        };

        // --- Sharing Logic ---
        window.shareCurrentMatch = async function() {
            let idToShare = null;
            let data = null;

            // Determine context and data
            if (!document.getElementById('viewer-screen').classList.contains('hidden')) {
                idToShare = activeViewerMatchId;
                data = viewerMatchData;
            } else if (!document.getElementById('scoring-screen').classList.contains('hidden')) {
                idToShare = currentMatchId;
                data = match;
            } else if (!document.getElementById('result-screen').classList.contains('hidden')) {
                idToShare = currentMatchId;
                data = match;
            }

            if (!idToShare || !data) {
                showToast("No active match to share", "error");
                return;
            }

            // Construct the URL
            const urlObj = new URL(window.location.href);
            urlObj.searchParams.set('matchId', idToShare);
            const shareUrl = urlObj.toString();

            // Construct Status Message
            const overs = Math.floor(data.balls / 6) + "." + (data.balls % 6);
            let statusMsg = "Live";
            let actionText = "Watch Live Scoring:";
            
            if (data.result) {
                statusMsg = "Result: " + data.result;
                actionText = "See Match Summary:";
            }
            else if (data.isAbandoned) statusMsg = "Abandoned";
            else if (data.isOnBreak) statusMsg = "Break";
            else if (data.target) {
                const runsNeeded = data.target - data.runs;
                const ballsLeft = (data.maxOvers * 6) - data.balls;
                statusMsg = `Target ${data.target} | Need ${runsNeeded} off ${ballsLeft} balls`;
            }

            const title = data.result ? "Match Result" : "Live Cricket Score";
            const text = `üèè ${data.battingTeam} vs ${data.bowlingTeam} ‚öæ\nScore: ${data.runs}/${data.wickets} (${overs} Overs)\n${statusMsg}\n\n${actionText}`;

            // Native Share with Fallback
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: title,
                        text: text,
                        url: shareUrl
                    });
                } catch (err) {
                    console.log("Share canceled or failed", err);
                }
            } else {
                // Clipboard Fallback for desktops/iframe restrictions
                const fullMsg = `${text} ${shareUrl}`;
                try {
                    await navigator.clipboard.writeText(fullMsg);
                    showToast("Match Status & Link Copied!", "success");
                } catch (err) {
                    // Legacy Fallback
                    const textArea = document.createElement("textarea");
                    textArea.value = fullMsg;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast("Match Status & Link Copied!", "success");
                    } catch (e) {
                        showToast("Could not copy link", "error");
                    }
                    document.body.removeChild(textArea);
                }
            }
        };

        const initAuth = async () => {
            try {
                const cred = await signInAnonymously(auth);
                user = cred.user;
                
                // Check if user came via a shared link
                const urlParams = new URLSearchParams(window.location.search);
                const sharedMatchId = urlParams.get('matchId');

                if (sharedMatchId) {
                    showToast("Loading Shared Match...", "info");
                    startWatching(sharedMatchId);
                } else {
                    // Normal startup
                    checkForActiveMatch();
                    // Set background checker every minute
                    setInterval(checkForActiveMatch, 60000);
                }

            } catch (err) { 
                showToast("Auth Failed: " + err.message, "error"); 
            }
        };
        initAuth();

        const setupScreen = document.getElementById('setup-screen');
        const scoringScreen = document.getElementById('scoring-screen');
        const historyScreen = document.getElementById('history-screen');
        const resultScreen = document.getElementById('result-screen');
        const viewerScreen = document.getElementById('viewer-screen');
        const syncStatus = document.getElementById('sync-status');
        const backBtn = document.getElementById('global-back-btn');
        const resumeContainer = document.getElementById('resume-container');
        const resumeInfo = document.getElementById('resume-match-info');
        const breakOverlay = document.getElementById('break-overlay');

        // Toss Variables & Functions
        const tossModal = document.getElementById('toss-modal');
        const coin = document.getElementById('coin');
        const tossControls = document.getElementById('toss-controls');
        const tossWinnerSelect = document.getElementById('toss-winner-select');
        const tossDecisionSelect = document.getElementById('toss-decision-select');

        // Get helper
        window.getTeamName = function(type) {
            const select = document.getElementById(`${type}-team-select`);
            if(select.value === 'custom') return document.getElementById(`${type}-team-input`).value.trim();
            return select.value;
        };

        window.setTeamName = function(type, name) {
            const select = document.getElementById(`${type}-team-select`);
            const input = document.getElementById(`${type}-team-input`);
            
            // Check if name is in options
            let found = false;
            for(let i=0; i<select.options.length; i++) {
                if(select.options[i].value === name) {
                    select.value = name;
                    found = true;
                    break;
                }
            }
            if(!found) {
                select.value = 'custom';
                input.value = name;
                input.classList.remove('hidden');
            } else {
                input.classList.add('hidden');
            }
        };

        window.openTossModal = function() {
            team1Name = getTeamName('batting');
            team2Name = getTeamName('bowling');

            if(!team1Name || !team2Name) {
                showToast("Please enter both team names first", "error");
                return;
            }
            if(team1Name === team2Name) {
                showToast("Teams must have different names", "error");
                return;
            }

            document.getElementById('btn-toss-team1').innerText = team1Name;
            document.getElementById('btn-toss-team2').innerText = team2Name;

            // Reset Modal State
            coin.style.transform = 'rotateY(0deg)';
            tossControls.classList.remove('hidden');
            tossWinnerSelect.classList.add('hidden');
            tossDecisionSelect.classList.add('hidden');
            
            tossModal.classList.remove('hidden');
            tossModal.querySelector('.relative').classList.remove('modal-active');
            tossModal.querySelector('.relative').classList.add('modal-enter');
            setTimeout(() => {
                tossModal.querySelector('.relative').classList.remove('modal-enter');
                tossModal.querySelector('.relative').classList.add('modal-active');
            }, 10);
        };

        window.closeTossModal = function() {
            tossModal.classList.add('hidden');
        };

        window.flipCoin = function() {
            tossControls.classList.add('hidden');
            const result = Math.random() < 0.5 ? 0 : 1; // 0 = Heads, 1 = Tails
            // 5 spins + result
            const rotate = 1800 + (result * 180); 
            coin.style.transform = `rotateY(${rotate}deg)`;
            
            setTimeout(() => {
                showToast(result === 0 ? "It's HEADS!" : "It's TAILS!", "info");
                tossWinnerSelect.classList.remove('hidden');
            }, 3000);
        };

        window.selectTossWinner = function(idx) {
            tossWinnerIdx = idx;
            const btn1 = document.getElementById('btn-toss-team1');
            const btn2 = document.getElementById('btn-toss-team2');
            
            // Highlight selection
            if(idx === 0) {
                btn1.classList.add('bg-orange-100', 'border-brand-primary', 'text-brand-primary');
                btn2.classList.remove('bg-orange-100', 'border-brand-primary', 'text-brand-primary');
            } else {
                btn2.classList.add('bg-orange-100', 'border-brand-primary', 'text-brand-primary');
                btn1.classList.remove('bg-orange-100', 'border-brand-primary', 'text-brand-primary');
            }
            tossDecisionSelect.classList.remove('hidden');
        };

        window.finalizeToss = function(choice) {
            const winnerName = tossWinnerIdx === 0 ? team1Name : team2Name;
            const loserName = tossWinnerIdx === 0 ? team2Name : team1Name;
            
            let finalBatting = "", finalBowling = "";
            
            if(choice === 'bat') {
                finalBatting = winnerName;
                finalBowling = loserName;
                showToast(`${winnerName} won toss & elected to BAT`, "success");
            } else {
                finalBatting = loserName;
                finalBowling = winnerName;
                showToast(`${winnerName} won toss & elected to BOWL`, "success");
            }

            // Update inputs
            setTeamName('batting', finalBatting);
            setTeamName('bowling', finalBowling);
            
            closeTossModal();
        };

        async function checkForActiveMatch() {
            if (!user) return;
            try {
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                const querySnapshot = await getDocs(q);
                const matches = [];
                querySnapshot.forEach(doc => matches.push({id: doc.id, ...doc.data()}));
                
                const now = new Date();
                
                // 1. GLOBAL CLEANUP: Identify ALL stale matches (not just the current user's)
                const staleMatches = matches.filter(m => {
                    if (m.status !== 'Live' && m.status !== 'On Break') return false;
                    
                    let lastActiveTime = new Date();
                    if (m.lastUpdated && typeof m.lastUpdated.toDate === 'function') {
                        lastActiveTime = m.lastUpdated.toDate();
                    } else if (m.lastUpdated && m.lastUpdated.seconds) {
                        lastActiveTime = new Date(m.lastUpdated.seconds * 1000);
                    } else if (typeof m.lastUpdated === 'string') {
                        lastActiveTime = new Date(m.lastUpdated);
                    } else if (m.startTime) {
                        lastActiveTime = new Date(m.startTime);
                    }

                    const diffMinutes = (now - lastActiveTime) / 1000 / 60;
                    return diffMinutes > 30;
                });

                // Update stale matches to Abandoned
                if (staleMatches.length > 0) {
                    const updates = staleMatches.map(m => {
                        const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', m.id);
                        return setDoc(matchRef, { 
                            ...m, 
                            status: "Abandoned", 
                            isAbandoned: true,
                            endTime: new Date().toISOString(),
                            lastUpdated: serverTimestamp()
                        }, { merge: true });
                    });
                    await Promise.all(updates);
                    console.log(`Auto-abandoned ${staleMatches.length} stale matches.`);
                }

                // 2. USER RESUME CHECK
                // Filter out the matches we just identified as stale to prevent resuming them
                const staleIds = staleMatches.map(sm => sm.id);
                
                // Find match this user is scoring that isn't finished/abandoned AND wasn't just marked stale
                const active = matches.find(m => 
                    m.scorerId === user.uid && 
                    m.status !== "Finished" && 
                    m.status !== "Abandoned" &&
                    !staleIds.includes(m.id)
                );
                
                if (active) {
                    activeMatchData = active;
                    resumeInfo.innerText = `üèè ${active.battingTeam} vs ‚öæ ${active.bowlingTeam}`;
                    // Only show resume button if we are on the setup screen
                    if (!setupScreen.classList.contains('hidden')) {
                        resumeContainer.classList.remove('hidden');
                    }
                } else {
                    // Safety check: If the user is currently SCORING a match that just got marked stale (e.g. left tab open 31 mins), kick them out
                    if (currentMatchId && staleIds.includes(currentMatchId) && !scoringScreen.classList.contains('hidden')) {
                        showToast("Session expired due to inactivity", "warning");
                        setTimeout(() => location.reload(), 2000);
                    }
                    
                    activeMatchData = null;
                    resumeContainer.classList.add('hidden');
                }
            } catch (err) { 
                console.warn("Match recovery silent failure", err); 
            }
        }

        window.resumeMatch = function() {
            if (!activeMatchData) return;
            currentMatchId = activeMatchData.id;
            match = {
                battingTeam: activeMatchData.battingTeam,
                bowlingTeam: activeMatchData.bowlingTeam,
                maxOvers: activeMatchData.maxOvers,
                playerCount: activeMatchData.playerCount || 11,
                innings: activeMatchData.innings,
                target: activeMatchData.target,
                runs: activeMatchData.runs,
                wickets: activeMatchData.wickets,
                balls: activeMatchData.balls,
                history: activeMatchData.history || [],
                redoStack: activeMatchData.redoStack || [],
                overHistory: activeMatchData.overHistory || [],
                startTime: activeMatchData.startTime || null,
                endTime: activeMatchData.endTime || null,
                isOnBreak: activeMatchData.isOnBreak || false,
                isAbandoned: activeMatchData.isAbandoned || false,
                result: activeMatchData.result || null,
                striker: activeMatchData.striker || "Striker",
                nonStriker: activeMatchData.nonStriker || "Non-Striker",
                bowler: activeMatchData.bowler || "Bowler",
                playerStats: activeMatchData.playerStats || {},
                bowlersList: activeMatchData.bowlersList || []
            };
            setupScreen.classList.add('hidden');
            scoringScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            resumeContainer.classList.add('hidden');
            updateDisplay();
            showToast("Match Resumed Successfully", "success");
        };

        window.toggleBreak = async function() {
            match.isOnBreak = !match.isOnBreak;
            updateDisplay();
            await syncToCloud();
            showToast(match.isOnBreak ? "Break Started" : "Play Resumed", "info");
        };

        window.abandonMatch = async function() {
            const confirmed = await showConfirm("Abandon this match? Logs will show 'No Result'.");
            if (confirmed) {
                match.isAbandoned = true;
                match.isOnBreak = false;
                match.endTime = new Date().toISOString();
                
                scoringScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                
                document.getElementById('result-emoji').innerText = "‚òÅÔ∏è";
                document.getElementById('result-header').innerText = "Match Abandoned";
                document.getElementById('winner-text').innerText = "No Result";
                document.getElementById('winner-text').className = "text-xl font-bold text-gray-500 mb-6";
                
                const sTime = match.startTime ? new Date(match.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                const eTime = match.endTime ? new Date(match.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';

                document.getElementById('final-stats').innerHTML = `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-[10px] uppercase text-gray-400 font-bold">Start</p>
                            <p class="text-sm font-bold text-gray-700">${sTime}</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-[10px] uppercase text-gray-400 font-bold">Ended</p>
                            <p class="text-sm font-bold text-gray-700">${eTime}</p>
                        </div>
                    </div>
                    <p>The match was called off before completion.</p>
                `;
                await syncToCloud();
                showToast("Match has been Abandoned", "warning");
            }
        };

        window.handleGlobalBack = async function() {
            if (!scoringScreen.classList.contains('hidden')) {
                const confirmed = await showConfirm("Exit scoring dashboard? Progress is safe in the cloud.");
                if (confirmed) {
                    resetAppState();
                    scoringScreen.classList.add('hidden');
                    setupScreen.classList.remove('hidden');
                    backBtn.classList.add('hidden');
                    checkForActiveMatch();
                }
            } else if (!historyScreen.classList.contains('hidden')) {
                hideHistory();
            } else if (!viewerScreen.classList.contains('hidden')) {
                stopWatching();
            } else if (!resultScreen.classList.contains('hidden')) {
                location.reload();
            }
        };

        function resetAppState() {
            currentMatchId = null;
            match = {
                battingTeam: "", bowlingTeam: "", maxOvers: 5, playerCount: 11,
                innings: 1, target: null, runs: 0, wickets: 0,
                balls: 0, history: [], redoStack: [], overHistory: [],
                startTime: null, endTime: null, isOnBreak: false,
                isAbandoned: false,
                result: null,
                striker: "Striker", nonStriker: "Non-Striker", bowler: "Bowler",
                playerStats: {},
                bowlersList: []
            };
        }

        window.toggleCustomTeam = function(type) {
            const select = document.getElementById(`${type}-team-select`);
            const input = document.getElementById(`${type}-team-input`);
            if (select.value === 'custom') {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
            }
        };

        window.startMatch = async function() {
            let bTeam = document.getElementById('batting-team-select').value;
            if (bTeam === 'custom') {
                bTeam = document.getElementById('batting-team-input').value.trim();
                if (!bTeam) { showToast("Please enter Batting Team name", "error"); return; }
            }

            let boTeam = document.getElementById('bowling-team-select').value;
            if (boTeam === 'custom') {
                boTeam = document.getElementById('bowling-team-input').value.trim();
                if (!boTeam) { showToast("Please enter Bowling Team name", "error"); return; }
            }

            if(bTeam === boTeam) { 
                showToast("Cannot select same team for both!", "error"); 
                return; 
            }
            match.battingTeam = bTeam; match.bowlingTeam = boTeam;
            match.maxOvers = parseInt(document.getElementById('max-overs').value);
            match.playerCount = parseInt(document.getElementById('player-count').value);
            match.startTime = new Date().toISOString();
            currentMatchId = "match_" + Date.now();
            setupScreen.classList.add('hidden');
            
            // Show Initial Players Modal instead of going directly to scoring
            const initModal = document.getElementById('initial-players-modal');
            initModal.classList.remove('hidden');
            initModal.querySelector('.relative').classList.add('modal-enter');
            setTimeout(() => {
                initModal.querySelector('.relative').classList.remove('modal-enter');
                initModal.querySelector('.relative').classList.add('modal-active');
            }, 10);
        };

        async function syncToCloud() {
            if (!user || !currentMatchId) return;
            document.getElementById('save-loader').classList.remove('hidden');
            syncStatus.classList.replace('bg-green-400', 'bg-yellow-400');
            try {
                let statusStr = "Live";
                if (match.isAbandoned) statusStr = "Abandoned";
                else if (!resultScreen.classList.contains('hidden')) statusStr = "Finished";
                else if (match.isOnBreak) statusStr = "On Break";

                const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', currentMatchId);
                await setDoc(matchRef, {
                    ...match, lastUpdated: serverTimestamp(), scorerId: user.uid,
                    status: statusStr
                });
                syncStatus.classList.replace('bg-yellow-400', 'bg-green-400');
            } catch (err) {
                syncStatus.classList.replace('bg-yellow-400', 'bg-red-500');
                showToast("Cloud sync failed. Check connection.", "warning");
            } finally {
                document.getElementById('save-loader').classList.add('hidden');
            }
        }

        window.addScore = async function(r) {
            if (match.isOnBreak || match.isAbandoned) return;
            saveState();
            match.runs += r; match.balls++; match.overHistory.push(r);
            
            // --- Stats Update ---
            const sStats = getStats(match.striker, match.battingTeam);
            sStats.runs += r; sStats.balls += 1;
            
            const bStats = getStats(match.bowler, match.bowlingTeam);
            bStats.runsConceded += r; bStats.ballsBowled += 1;
            // --------------------

            // Auto-rotate strike on 1s and 3s
            if (r === 1 || r === 3 || r === 5) {
                const temp = match.striker;
                match.striker = match.nonStriker;
                match.nonStriker = temp;
            }

            // Check for over completion
            if (match.balls % 6 === 0) handleEndOfOver();
            
            checkInningsStatus(); updateDisplay(); await syncToCloud();
        };

        window.addExtra = async function(type) {
            if (match.isOnBreak || match.isAbandoned) return;
            
            if (type === 'NB') {
                // Open Modal for runs
                const nbModal = document.getElementById('nb-runs-modal');
                nbModal.classList.remove('hidden');
                nbModal.querySelector('.relative').classList.add('modal-enter');
                setTimeout(() => {
                    nbModal.querySelector('.relative').classList.remove('modal-enter');
                    nbModal.querySelector('.relative').classList.add('modal-active');
                }, 10);
                return;
            }

            saveState();
            match.runs += 1; match.overHistory.push(type);
            
            // --- Stats Update ---
            const bStats = getStats(match.bowler, match.bowlingTeam);
            bStats.runsConceded += 1;
            // --------------------

            updateDisplay(); await syncToCloud();
        };

        window.addWicket = async function() {
            if (match.isOnBreak || match.isAbandoned) return;
            saveState();
            match.wickets++; match.balls++; match.overHistory.push('W');
            
            // --- Stats Update ---
            const sStats = getStats(match.striker, match.battingTeam);
            sStats.balls += 1;
            sStats.isOut = true; // Mark as out
            
            const bStats = getStats(match.bowler, match.bowlingTeam);
            bStats.wickets += 1; bStats.ballsBowled += 1;
            // --------------------

            // Show New Batsman Modal
            const newBatModal = document.getElementById('new-batsman-modal');
            newBatModal.classList.remove('hidden');
            newBatModal.querySelector('.relative').classList.add('modal-enter');
            setTimeout(() => {
                newBatModal.querySelector('.relative').classList.remove('modal-enter');
                newBatModal.querySelector('.relative').classList.add('modal-active');
                document.getElementById('new-batsman-name').focus();
            }, 10);

            // Check for over completion
            if (match.balls % 6 === 0) handleEndOfOver();

            checkInningsStatus(); updateDisplay(); await syncToCloud();
        };

        function handleEndOfOver() {
            // Guard clause to prevent popup if innings/match is over
            const totalBalls = match.maxOvers * 6;
            const maxWickets = match.playerCount - 1;
            const isInningsOver = match.balls >= totalBalls || match.wickets >= maxWickets;
            const isMatchWon = match.innings === 2 && match.target && match.runs >= match.target;

            if (isInningsOver || isMatchWon) return;

            // Rotate Strike at end of over
            const temp = match.striker;
            match.striker = match.nonStriker;
            match.nonStriker = temp;

            // Populate Bowler Select
            const select = document.getElementById('existing-bowler-select');
            select.innerHTML = '<option value="">-- Select --</option>';
            match.bowlersList.forEach(b => {
                if (b !== match.bowler) { // Don't allow same bowler consecutively in standard logic, though gully allows.
                     const opt = document.createElement('option');
                     opt.value = b; opt.innerText = b;
                     select.appendChild(opt);
                }
            });

            // Show Modal
            const modal = document.getElementById('next-bowler-modal');
            modal.classList.remove('hidden');
            modal.querySelector('.relative').classList.add('modal-enter');
            setTimeout(() => {
                modal.querySelector('.relative').classList.remove('modal-enter');
                modal.querySelector('.relative').classList.add('modal-active');
            }, 10);
        }

        function checkInningsStatus() {
            const totalBalls = match.maxOvers * 6;
            const maxWickets = match.playerCount - 1; 
            
            if (match.innings === 1) {
                if (match.wickets >= maxWickets || match.balls >= totalBalls) switchToSecondInnings();
            } else {
                if (match.runs >= match.target) endMatch(match.battingTeam + " wins!");
                else if (match.wickets >= maxWickets || match.balls >= totalBalls) {
                    if (match.runs === match.target - 1) endMatch("It's a Draw!");
                    else endMatch(match.bowlingTeam + " wins!");
                }
            }
        }

        function switchToSecondInnings() {
            showToast(`First Innings Finished! Target: ${match.runs + 1}`, "warning");
            const prevRuns = match.runs; const temp = match.battingTeam;
            match.battingTeam = match.bowlingTeam; match.bowlingTeam = temp;
            match.target = prevRuns + 1; match.runs = 0; match.wickets = 0; match.balls = 0;
            match.innings = 2; match.overHistory = []; match.history = []; match.redoStack = [];
            
            // Reset Players
            match.striker = "Striker"; match.nonStriker = "Non-Striker"; match.bowler = "Bowler";
            match.bowlersList = []; // New innings, new bowlers (or same players but bowling for other team now)

            document.getElementById('display-target').classList.remove('hidden');
            document.getElementById('rrr-container').classList.remove('hidden');
            
            // Re-prompt for initial players for 2nd innings? Ideally yes, but sticking to flow.
            // Let's trigger the initial popup again for the new innings.
            const initModal = document.getElementById('initial-players-modal');
            document.getElementById('init-striker').value = '';
            document.getElementById('init-non-striker').value = '';
            document.getElementById('init-bowler').value = '';
            initModal.classList.remove('hidden');
        }

        function endMatch(winner) {
            match.result = winner;
            match.endTime = new Date().toISOString();
            match.isOnBreak = false;
            scoringScreen.classList.add('hidden'); resultScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            document.getElementById('winner-text').innerText = winner;
            document.getElementById('result-emoji').innerText = "üèÜ";
            document.getElementById('result-header').innerText = "Match Finished!";
            document.getElementById('winner-text').className = "text-xl font-bold text-[#F7631B] mb-6";
            
            const sTime = match.startTime ? new Date(match.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
            const eTime = match.endTime ? new Date(match.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';

            document.getElementById('final-stats').innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-gray-50 p-2 rounded">
                        <p class="text-[10px] uppercase text-gray-400 font-bold">Start</p>
                        <p class="text-sm font-bold text-gray-700">${sTime}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <p class="text-[10px] uppercase text-gray-400 font-bold">End</p>
                        <p class="text-sm font-bold text-gray-700">${eTime}</p>
                    </div>
                </div>
                <p class="font-bold">Final Score: ${match.runs}/${match.wickets} in ${formatOvers(match.balls)} overs</p>
                <p class="text-[10px] text-gray-400 uppercase mt-2">Played with ${match.playerCount} players per team</p>
            `;
            syncToCloud();
            showToast("Match Finished - Summary Generated", "success");
        }

        function updateDisplay() {
            document.getElementById('display-teams').innerText = `üèè ${match.battingTeam} vs ‚öæ ${match.bowlingTeam}`;
            document.getElementById('runs').innerText = match.runs;
            document.getElementById('wickets').innerText = match.wickets;
            document.getElementById('overs').innerText = formatOvers(match.balls);
            document.getElementById('limit').innerText = match.maxOvers;
            
            // --- Update Player Stats Display ---
            const sStats = getStats(match.striker, match.battingTeam);
            const nsStats = getStats(match.nonStriker, match.battingTeam);
            const bStats = getStats(match.bowler, match.bowlingTeam);
            
            document.getElementById('label-striker').innerText = `${match.striker} (${sStats.runs} off ${sStats.balls})`;
            document.getElementById('label-nonStriker').innerText = `${match.nonStriker} (${nsStats.runs} off ${nsStats.balls})`;
            document.getElementById('label-bowler').innerText = `${match.bowler} (${bStats.wickets}-${bStats.runsConceded}, ${formatOvers(bStats.ballsBowled)})`;
            // ------------------------------------

            if (match.isOnBreak) breakOverlay.classList.remove('hidden');
            else breakOverlay.classList.add('hidden');

            if (match.startTime) {
                const time = new Date(match.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                document.getElementById('start-time-label').innerText = `Started: ${time}`;
            }

            if (match.target) {
                document.getElementById('display-target').innerText = `TARGET: ${match.target}`;
                document.getElementById('display-target').classList.remove('hidden');
                document.getElementById('rrr-container').classList.remove('hidden');
                const ballsLeft = (match.maxOvers * 6) - match.balls;
                const rrr = ballsLeft > 0 ? ((match.target - match.runs) / (ballsLeft / 6)).toFixed(2) : "0.00";
                document.getElementById('rrr').innerText = rrr;
            } else {
                document.getElementById('display-target').classList.add('hidden');
                document.getElementById('rrr-container').classList.add('hidden');
            }
            const crr = match.balls > 0 ? (match.runs / (match.balls / 6)).toFixed(2) : "0.00";
            document.getElementById('crr').innerText = crr;
            renderBalls(document.getElementById('over-history'), match.balls, match.overHistory);
        }

        function renderBalls(container, totalBalls, ballsList) {
            container.innerHTML = ''; 
            let currentOverBalls = [];
            
            if (ballsList.length > 0) {
                let legalBallsToSkip = 0;
                
                // Calculate where the current over started based on legal balls count
                if (totalBalls > 0 && totalBalls % 6 === 0) {
                    const lastBall = ballsList[ballsList.length - 1];
                    // Check if last ball was extra. If so, we are in the NEXT over (e.g. 0.1), so skip previous completed overs.
                    // If last ball was legal, we are at End of Over (e.g. 1.0), so show that completed over.
                    const isLastBallExtra = lastBall === 'WD' || lastBall === 'NB' || (typeof lastBall === 'string' && lastBall.startsWith('NB'));
                    
                    if (isLastBallExtra) {
                        legalBallsToSkip = totalBalls;
                    } else {
                        legalBallsToSkip = totalBalls - 6;
                    }
                } else {
                    // Mid-over or start of innings
                    legalBallsToSkip = Math.floor(totalBalls / 6) * 6;
                }

                let legalCount = 0; 
                let startIndex = 0;
                
                for (let i = 0; i < ballsList.length; i++) {
                    if (legalCount >= legalBallsToSkip) { 
                        startIndex = i; 
                        break; 
                    }
                    const b = ballsList[i];
                    const isExtra = b === 'WD' || b === 'NB' || (typeof b === 'string' && b.startsWith('NB'));
                    if (!isExtra) legalCount++;
                }
                currentOverBalls = ballsList.slice(startIndex);
            }

            currentOverBalls.forEach(ball => {
                const span = document.createElement('span');
                span.className = 'ball-dot ' + getBallColor(ball);
                if(ball.toString().length > 2) span.classList.add('text-[10px]', '!px-1');
                span.innerText = ball; container.appendChild(span);
            });
        }

        function getBallColor(val) {
            const s = val.toString();
            if (s === '0') return 'bg-gray-50 text-gray-400 border-gray-200';
            if (s === '1') return 'bg-white text-gray-600 border-gray-200';
            if (s === '2') return 'bg-white text-gray-700 border-gray-300';
            if (s === '3') return 'bg-white text-gray-800 border-gray-400';
            if (s === '4') return 'bg-blue-500 text-white border-blue-600 shadow-sm';
            if (s === '6') return 'bg-[#F7631B] text-white border-orange-600 shadow-sm';
            if (s === 'W') return 'bg-red-500 text-white border-red-600 shadow-sm';
            if (s === 'WD' || s.startsWith('NB')) return 'bg-yellow-100 text-yellow-800 border-yellow-300';
            return 'bg-white text-gray-800 border-gray-300';
        }

        function formatOvers(balls) { return `${Math.floor(balls / 6)}.${balls % 6}`; }

        function saveState() {
            // Need to deep copy playerStats to avoid reference issues
            const statsCopy = JSON.parse(JSON.stringify(match.playerStats));
            match.history.push(JSON.stringify({
                runs: match.runs, wickets: match.wickets, balls: match.balls, overHistory: [...match.overHistory],
                striker: match.striker, nonStriker: match.nonStriker, bowler: match.bowler,
                playerStats: statsCopy, bowlersList: [...match.bowlersList]
            }));
            if (match.history.length > 30) match.history.shift();
            match.redoStack = [];
        }

        window.undoLast = async function() {
            if (match.history.length === 0 || match.isOnBreak) return;
            const statsCopy = JSON.parse(JSON.stringify(match.playerStats));
            match.redoStack.push(JSON.stringify({
                runs: match.runs, wickets: match.wickets, balls: match.balls, overHistory: [...match.overHistory],
                striker: match.striker, nonStriker: match.nonStriker, bowler: match.bowler,
                playerStats: statsCopy, bowlersList: [...match.bowlersList]
            }));
            const prevState = JSON.parse(match.history.pop());
            match.runs = prevState.runs; match.wickets = prevState.wickets;
            match.balls = prevState.balls; match.overHistory = prevState.overHistory;
            if(prevState.striker) match.striker = prevState.striker;
            if(prevState.nonStriker) match.nonStriker = prevState.nonStriker;
            if(prevState.bowler) match.bowler = prevState.bowler;
            if(prevState.playerStats) match.playerStats = prevState.playerStats;
            if(prevState.bowlersList) match.bowlersList = prevState.bowlersList;
            
            updateDisplay(); await syncToCloud();
            showToast("Action Undone", "info");
        };

        window.redoLast = async function() {
            if (match.redoStack.length === 0 || match.isOnBreak) return;
            const statsCopy = JSON.parse(JSON.stringify(match.playerStats));
            match.history.push(JSON.stringify({
                runs: match.runs, wickets: match.wickets, balls: match.balls, overHistory: [...match.overHistory],
                striker: match.striker, nonStriker: match.nonStriker, bowler: match.bowler,
                playerStats: statsCopy, bowlersList: [...match.bowlersList]
            }));
            const nextState = JSON.parse(match.redoStack.pop());
            match.runs = nextState.runs; match.wickets = nextState.wickets;
            match.balls = nextState.balls; match.overHistory = nextState.overHistory;
            if(nextState.striker) match.striker = nextState.striker;
            if(nextState.nonStriker) match.nonStriker = nextState.nonStriker;
            if(nextState.bowler) match.bowler = nextState.bowler;
            if(nextState.playerStats) match.playerStats = nextState.playerStats;
            if(nextState.bowlersList) match.bowlersList = nextState.bowlersList;

            updateDisplay(); await syncToCloud();
            showToast("Action Redone", "info");
        };

        window.showHistory = function() {
            setupScreen.classList.add('hidden'); 
            historyScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden'); 
            resumeContainer.classList.add('hidden');
            
            // Reset tab to live when opening
            switchLogTab('live');
            
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="text-center py-10 text-xs text-gray-400">Connecting to Tournament Stream...</div>';
            
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
            unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                allMatchesCache = [];
                querySnapshot.forEach(doc => allMatchesCache.push({id: doc.id, ...doc.data()}));
                
                allMatchesCache.sort((a, b) => {
                    const timeA = a.startTime ? new Date(a.startTime).getTime() : 0;
                    const timeB = b.startTime ? new Date(b.startTime).getTime() : 0;
                    return timeB - timeA;
                });
                
                renderHistoryList();

            }, (err) => {
                showToast("Stream lost. Please back and return.", "error");
            });
        };

        window.switchLogTab = function(tab) {
            currentLogTab = tab;
            
            const btnLive = document.getElementById('tab-live');
            const btnPast = document.getElementById('tab-past');
            
            if (tab === 'live') {
                btnLive.className = "flex-1 flex items-center justify-center gap-2 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all shadow-sm bg-white text-red-600 border border-red-100";
                btnLive.innerHTML = `
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                    </span>
                    Live Now
                `;
                
                btnPast.className = "flex-1 flex items-center justify-center gap-2 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all text-gray-500 hover:bg-gray-200 border border-transparent";
                btnPast.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Past Matches
                `;
            } else {
                btnLive.className = "flex-1 flex items-center justify-center gap-2 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all text-gray-500 hover:bg-gray-200 border border-transparent";
                btnLive.innerHTML = `
                    <span class="relative flex h-2 w-2">
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-gray-400"></span>
                    </span>
                    Live Now
                `;

                btnPast.className = "flex-1 flex items-center justify-center gap-2 py-2.5 text-xs font-bold uppercase tracking-wider rounded-lg transition-all shadow-sm bg-white text-gray-800 border border-gray-200";
                btnPast.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Past Matches
                `;
            }
            
            renderHistoryList();
        };

        function renderHistoryList() {
            const list = document.getElementById('history-list');
            
            if (allMatchesCache.length === 0) { 
                list.innerHTML = '<div class="text-center py-10 text-gray-400">No match records found.</div>'; 
                return; 
            }

            const live = allMatchesCache.filter(m => m.status === 'Live' || m.status === 'On Break');
            const past = allMatchesCache.filter(m => m.status !== 'Live' && m.status !== 'On Break');

            const renderCard = (m) => {
                const sT = m.startTime ? new Date(m.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                const eT = m.endTime ? new Date(m.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                let sCol = 'bg-gray-100 text-gray-600';
                let btnText = "View Match Summary";
                let resultBadge = '';
                let borderClass = 'border-l-4 border-l-gray-300';
                
                if (m.status === 'Live') {
                    sCol = 'bg-green-100 text-green-700 animate-pulse';
                    btnText = "View Live Score";
                    borderClass = 'border-l-4 border-l-green-500';
                } else if (m.status === 'On Break') {
                    sCol = 'bg-blue-100 text-blue-700';
                    btnText = "View Live Score";
                    borderClass = 'border-l-4 border-l-blue-400';
                } else if (m.status === 'Abandoned') {
                    sCol = 'bg-red-50 text-red-400';
                    resultBadge = `<div class="mt-3 mb-1 text-center font-bold text-sm text-red-500 bg-red-50 py-1 rounded-lg border border-red-100">‚õî Match Abandoned</div>`;
                    borderClass = 'border-l-4 border-l-red-300';
                } else if (m.status === 'Finished' && m.result) {
                        resultBadge = `<div class="mt-3 mb-1 text-center font-bold text-sm text-[#F7631B] bg-orange-50 py-1 rounded-lg border border-orange-100">üèÜ ${m.result}</div>`;
                        borderClass = 'border-l-4 border-l-[#F7631B]';
                }

                return `
                    <div class="bg-white border rounded-xl p-4 shadow-sm hover:shadow-md transition-shadow ${borderClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex flex-col">
                                <span class="text-[10px] font-bold text-gray-400 uppercase">${m.startTime ? new Date(m.startTime).toLocaleDateString([], {month:'short', day:'numeric'}) : 'Today'}</span>
                                <span class="text-[9px] text-gray-500">${sT} ${eT ? ' - ' + eT : ''}</span>
                            </div>
                            <span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${sCol}">${m.status}</span>
                        </div>
                        <div class="flex justify-between items-center mb-3">
                            <div class="font-bold text-gray-800">üèè ${m.battingTeam} <span class="text-gray-400 text-[10px] lowercase">vs</span> ‚öæ ${m.bowlingTeam}</div>
                            <div class="text-right">
                                <p class="text-xl font-black text-gray-900">${m.runs}/${m.wickets}</p>
                                <p class="text-[10px] text-gray-500">${formatOvers(m.balls)} Overs</p>
                            </div>
                        </div>
                        ${resultBadge}
                        <button onclick="startWatching('${m.id}')" class="w-full py-2 text-xs font-bold text-brand-primary border border-orange-100 bg-orange-50 rounded-lg uppercase tracking-tight mt-1 hover:bg-orange-100 transition-colors">${btnText}</button>
                    </div>
                `;
            };

            let finalHtml = '';
            
            if (currentLogTab === 'live') {
                if (live.length > 0) {
                    finalHtml = `
                        <div class="mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div class="flex items-center justify-between mb-3 px-1">
                                <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest">Active Matches</h3>
                                <span class="text-[10px] font-bold text-white bg-green-500 px-2 py-0.5 rounded-full shadow-sm shadow-green-200">${live.length} Live</span>
                            </div>
                            <div class="grid gap-4">
                                ${live.map(m => renderCard(m)).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    finalHtml = `
                        <div class="flex flex-col items-center justify-center py-16 opacity-50">
                            <div class="text-4xl mb-2">üèè</div>
                            <p class="font-bold text-gray-500">No live matches</p>
                            <p class="text-xs text-gray-400">Start a new match to see it here</p>
                        </div>
                    `;
                }
            } else {
                if (past.length > 0) {
                    finalHtml = `
                        <div class="animate-in fade-in slide-in-from-bottom-4 duration-500">
                            <div class="flex items-center gap-2 mb-4 px-1">
                                <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest">Match Archive</h3>
                            </div>
                            <div class="grid gap-3">
                                ${past.map(m => renderCard(m)).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    finalHtml = `
                        <div class="flex flex-col items-center justify-center py-16 opacity-50">
                            <div class="text-4xl mb-2">üìÇ</div>
                            <p class="font-bold text-gray-500">No history found</p>
                            <p class="text-xs text-gray-400">Completed matches will appear here</p>
                        </div>
                    `;
                }
            }
            
            list.innerHTML = finalHtml;
        }

        window.startWatching = function(matchId) {
            activeViewerMatchId = matchId; // Store for sharing logic
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeHistory = null;
            historyScreen.classList.add('hidden');
            setupScreen.classList.add('hidden'); 
            viewerScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            
            const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId);
            unsubscribeMatch = onSnapshot(matchRef, (docSnap) => {
                if (docSnap.exists()) updateViewerUI(docSnap.data());
                else { 
                    showToast("This match data was removed.", "error"); 
                    stopWatching(); 
                }
            }, (err) => {
                showToast("Lost connection to match.", "error");
                stopWatching();
            });
        };

        function updateViewerUI(data) {
            viewerMatchData = data; // Store latest data for sharing
            document.getElementById('v-display-teams').innerText = `üèè ${data.battingTeam} vs ‚öæ ${data.bowlingTeam}`;
            document.getElementById('v-runs').innerText = data.runs; document.getElementById('v-wickets').innerText = data.wickets;
            document.getElementById('v-overs').innerText = formatOvers(data.balls); document.getElementById('v-limit').innerText = data.maxOvers;
            
            // --- Update Viewer Player Stats Display ---
            const stats = data.playerStats || {};
            const getS = (n) => stats[n] || { runs: 0, balls: 0, wickets: 0, runsConceded: 0, ballsBowled: 0, isOut: false };
            
            const sStats = getS(data.striker || "Striker");
            const nsStats = getS(data.nonStriker || "Non-Striker");
            const bStats = getS(data.bowler || "Bowler");

            document.getElementById('v-label-striker').innerText = `${data.striker || "Striker"} (${sStats.runs} off ${sStats.balls})`;
            document.getElementById('v-label-nonStriker').innerText = `${data.nonStriker || "Non-Striker"} (${nsStats.runs} off ${nsStats.balls})`;
            document.getElementById('v-label-bowler').innerText = `${data.bowler || "Bowler"} (${bStats.wickets}-${bStats.runsConceded}, ${formatOvers(bStats.ballsBowled)})`;
            
            // --- Handle Overlay ---
            const vB = document.getElementById('v-break-overlay');
            if (data.status === "On Break" || data.status === "Abandoned") {
                vB.classList.remove('hidden');
                if (data.status === "Abandoned") {
                    document.getElementById('v-overlay-icon').innerText = "‚òÅÔ∏è";
                    document.getElementById('v-overlay-title').innerText = "Abandoned";
                    document.getElementById('v-overlay-desc').innerText = "This match was called off.";
                    document.getElementById('v-overlay-desc').className = "text-sm text-gray-300 mt-2";
                } else {
                    document.getElementById('v-overlay-icon').innerText = "‚òï";
                    document.getElementById('v-overlay-title').innerText = "Break Time";
                    document.getElementById('v-overlay-desc').innerText = "Play is currently paused.";
                    document.getElementById('v-overlay-desc').className = "text-sm text-gray-300 mt-2";
                }
            } else {
                vB.classList.add('hidden');
            }

            // --- Generate Full Scorecard with Result Banner ---
            let resultBanner = '';
            if (data.status === "Finished") {
                resultBanner = `
                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 border border-orange-200 p-4 rounded-xl text-center mb-4">
                        <div class="text-4xl mb-2">üèÜ</div>
                        <h3 class="text-lg font-black text-gray-800 uppercase tracking-tight">Match Finished</h3>
                        <p class="text-xl font-bold text-[#F7631B] mt-1">${data.result || 'Result Declared'}</p>
                    </div>
                `;
            }

            // Group By Team Logic
            const teamsMap = {};
            // Ensure current teams exist in map
            if (data.battingTeam) teamsMap[data.battingTeam] = { name: data.battingTeam, wickets: [], bowlers: [] };
            if (data.bowlingTeam) teamsMap[data.bowlingTeam] = { name: data.bowlingTeam, wickets: [], bowlers: [] };

            Object.keys(stats).forEach(playerName => {
                const p = stats[playerName];
                let tName = p.team;
                
                // Fallback for legacy data/current players if team not set
                if (!tName) {
                    if (playerName === data.striker || playerName === data.nonStriker) tName = data.battingTeam;
                    else if (playerName === data.bowler) tName = data.bowlingTeam;
                    else tName = 'Other'; 
                }

                if (!teamsMap[tName]) teamsMap[tName] = { name: tName, wickets: [], bowlers: [] };
                
                if (p.isOut) teamsMap[tName].wickets.push({name: playerName, ...p});
                if (p.ballsBowled > 0 || p.runsConceded > 0) teamsMap[tName].bowlers.push({name: playerName, ...p});
            });

            let fullHtml = resultBanner;

            Object.values(teamsMap).forEach(team => {
                if (team.name === 'Other' && team.wickets.length === 0 && team.bowlers.length === 0) return;
                
                // Only show if there is data
                // Commented out to ensure headers show even if empty
                // if (team.wickets.length === 0 && team.bowlers.length === 0) return;

                let teamHtml = `<div class="mb-4 bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                        <h3 class="font-black text-gray-800 uppercase tracking-wider">${team.name}</h3>
                    </div>
                    <div class="p-4 space-y-6">`;
                
                // Wickets Section
                teamHtml += `<div>
                    <h4 class="text-[10px] font-bold text-[#F7631B] uppercase tracking-widest mb-2 flex items-center gap-1">
                        <span>üèè</span> Fall of Wickets
                    </h4>`;
                
                if (team.wickets.length > 0) {
                     let wHtml = '';
                     team.wickets.forEach(p => {
                        wHtml += `
                        <div class="flex justify-between items-center text-xs text-gray-700 py-1.5 border-b border-dashed border-gray-100 last:border-0">
                            <span class="font-bold">${p.name}</span>
                            <span class="font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-600">${p.runs} <span class="text-[9px]">(${p.balls})</span></span>
                        </div>`;
                     });
                     teamHtml += `<div class="pl-1">${wHtml}</div>`;
                } else {
                     teamHtml += `<p class="text-[10px] text-gray-400 italic pl-1">No wickets yet.</p>`;
                }
                teamHtml += `</div>`;

                // Bowling Section
                teamHtml += `<div>
                    <h4 class="text-[10px] font-bold text-[#F7631B] uppercase tracking-widest mb-2 flex items-center gap-1">
                        <span>‚öæ</span> Bowling Figures
                    </h4>`;
                
                if (team.bowlers.length > 0) {
                     let bHtml = `
                        <div class="flex justify-between text-[9px] uppercase text-gray-400 font-bold mb-2 pl-1">
                            <span>Bowler</span>
                            <span>O-M-R-W</span>
                        </div>`;
                     team.bowlers.forEach(p => {
                        // Note: M (Maidens) not tracked currently, using O-R-W format or standard
                        bHtml += `
                        <div class="flex justify-between items-center text-xs text-gray-700 py-1.5 border-b border-dashed border-gray-100 last:border-0 pl-1">
                            <span class="font-bold">${p.name}</span>
                            <span class="font-mono bg-gray-100 px-2 py-0.5 rounded text-gray-600">${formatOvers(p.ballsBowled)} - ${p.runsConceded} - ${p.wickets}</span>
                        </div>`;
                     });
                     teamHtml += `<div>${bHtml}</div>`;
                } else {
                     teamHtml += `<p class="text-[10px] text-gray-400 italic pl-1">No bowling stats.</p>`;
                }
                teamHtml += `</div>`; // End Bowling section

                teamHtml += `</div></div>`; // End Card
                
                fullHtml += teamHtml;
            });

            document.getElementById('v-full-scorecard').innerHTML = fullHtml || '<div class="text-center text-gray-400 py-4 text-xs">Match just started. Waiting for stats.</div>';
            // ------------------------------------------

            if (data.startTime) document.getElementById('v-start-time-label').innerText = `Started: ${new Date(data.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            
            if (data.target) {
                document.getElementById('v-display-target').innerText = `TARGET: ${data.target}`;
                document.getElementById('v-display-target').classList.remove('hidden');
                document.getElementById('v-rrr-box').classList.remove('hidden');
                const bl = (data.maxOvers * 6) - data.balls; 
                const rrr = bl > 0 ? ((data.target - data.runs) / (bl / 6)).toFixed(2) : "0.00";
                document.getElementById('v-rrr').innerText = rrr;
            } else {
                document.getElementById('v-display-target').classList.add('hidden');
                document.getElementById('v-rrr-box').classList.add('hidden');
            }
            document.getElementById('v-crr').innerText = data.balls > 0 ? (data.runs / (data.balls / 6)).toFixed(2) : "0.00";
            renderBalls(document.getElementById('v-over-history'), data.balls, data.overHistory || []);
        }

        window.stopWatching = function() {
            activeViewerMatchId = null; // Reset
            // Clear URL param if present
            const url = new URL(window.location.href);
            if (url.searchParams.has('matchId')) {
                url.searchParams.delete('matchId');
                window.history.pushState({}, '', url);
            }

            if (unsubscribeMatch) unsubscribeMatch(); unsubscribeMatch = null;
            viewerScreen.classList.add('hidden'); showHistory(); 
            showToast("Returned to logs", "info");
        };

        window.hideHistory = function() { 
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeHistory = null;
            historyScreen.classList.add('hidden'); 
            setupScreen.classList.remove('hidden'); 
            backBtn.classList.add('hidden'); 
            checkForActiveMatch();
        };
    </script>
</body>
</html>
