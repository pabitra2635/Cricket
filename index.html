<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gully Cricket Live Scorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .ball-dot { @apply w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold border; }
        .bg-brand-primary { background-color: #F7631B; }
        .text-brand-primary { color: #F7631B; }
        .border-brand-primary { border-color: #F7631B; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #F7631B; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .break-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        
        /* Toast Animation */
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(20px); opacity: 0; transition: all 0.3s ease-in; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col relative">
        
        <!-- Header -->
        <header class="bg-brand-primary text-white p-4 shadow-md sticky top-0 z-50">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <button id="global-back-btn" onclick="handleGlobalBack()" class="hidden p-1 hover:bg-orange-600 rounded-full transition-colors mr-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <img src="https://mgcub.ac.in/images/rotate.png" alt="Logo" class="h-10 w-10 object-contain bg-white rounded-full p-1">
                    <div>
                        <h1 class="text-lg font-bold tracking-wider leading-tight uppercase">Gully Premier League</h1>
                        <div class="flex items-center gap-2">
                            <span id="sync-status" class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                            <p id="header-subtitle" class="text-[9px] text-orange-100 uppercase tracking-widest">Live Cloud Sync Active</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Setup Screen -->
        <div id="setup-screen" class="p-6 flex-grow flex flex-col">
            <div class="text-center mb-6">
                <img src="https://mgcub.ac.in/images/rotate.png" alt="MGCUB Logo" class="mx-auto h-20 w-20 mb-2 object-contain">
                <h2 class="text-lg font-semibold text-gray-700">Tournament Setup</h2>
            </div>
            
            <div class="space-y-4 flex-grow">
                <div id="resume-container" class="hidden animate-bounce">
                    <button onclick="resumeMatch()" class="w-full bg-green-50 border-2 border-green-500 text-green-700 p-4 rounded-xl flex items-center justify-between shadow-sm">
                        <div class="text-left">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-green-600">Active Match Found</p>
                            <p class="font-black text-sm" id="resume-match-info">Loading...</p>
                        </div>
                        <div class="flex items-center gap-1 font-bold text-xs uppercase">
                            Resume <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
                        </div>
                    </button>
                    <div class="mt-2 h-[1px] bg-gray-200"></div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">Batting Team</label>
                    <select id="batting-team" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                        <option value="B.Tech">B.Tech</option>
                        <option value="MBA">MBA</option>
                        <option value="B.Com">B.Com</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">Bowling Team</label>
                    <select id="bowling-team" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                        <option value="MBA">MBA</option>
                        <option value="B.Tech">B.Tech</option>
                        <option value="B.Com">B.Com</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1 font-bold">Overs Per Innings</label>
                    <input type="number" id="max-overs" value="5" min="1" max="50" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-[#F7631B] outline-none font-semibold">
                </div>

                <button onclick="startMatch()" class="w-full bg-brand-primary hover:opacity-90 text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 uppercase tracking-widest mt-2">
                    Start New Match
                </button>

                <button onclick="showHistory()" class="w-full bg-gray-100 text-gray-600 font-bold py-3 rounded-xl border border-gray-300 transition-transform active:scale-95 uppercase text-sm">
                    View Match History
                </button>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="hidden p-6 flex-grow overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-gray-800">Tournament Logs</h2>
                <div id="history-sync-indicator" class="hidden"><div class="loader !w-4 !h-4"></div></div>
            </div>
            <div id="history-list" class="space-y-4 pb-10">
                <div class="text-center text-gray-500 py-10">Connecting to Tournament Stream...</div>
            </div>
        </div>

        <!-- Viewer Screen -->
        <div id="viewer-screen" class="hidden flex-grow flex flex-col relative">
             <div class="bg-gray-900 text-white p-6 text-center">
                <div class="flex justify-between items-center mb-1">
                    <span id="v-display-teams" class="text-sm font-medium text-gray-400 uppercase tracking-widest font-bold">Loading...</span>
                    <span id="v-display-target" class="text-sm text-[#F7631B] font-bold hidden uppercase">TARGET: 0</span>
                </div>
                <div id="v-start-time-label" class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest font-medium">Started: --:--</div>
                
                <div class="text-5xl font-black mb-1">
                    <span id="v-runs">0</span>/<span id="v-wickets">0</span>
                </div>
                <div class="text-lg text-gray-400 font-bold">
                    Overs: <span id="v-overs">0.0</span> / <span id="v-limit">5</span>
                </div>
                <div class="mt-4 flex justify-around text-xs border-t border-gray-800 pt-4">
                    <div class="text-center"><p class="text-gray-500 uppercase font-bold">Run Rate</p><p class="text-lg font-bold" id="v-crr">0.00</p></div>
                    <div id="v-rrr-box" class="text-center hidden"><p class="text-gray-500 uppercase font-bold">Req Rate</p><p class="text-lg font-bold text-[#F7631B]" id="v-rrr">0.00</p></div>
                </div>
            </div>

            <!-- Viewer Break/Abandon Overlay -->
            <div id="v-break-overlay" class="hidden absolute inset-0 z-10 break-overlay flex flex-col items-center justify-center text-white text-center p-6">
                <div id="v-overlay-icon" class="text-4xl mb-4">‚òï</div>
                <h3 id="v-overlay-title" class="text-2xl font-black uppercase tracking-tighter">Match on Break</h3>
                <p id="v-overlay-desc" class="text-sm text-gray-300 mt-2">Waiting for teams to resume play...</p>
            </div>

            <div class="p-4 bg-gray-50 border-b flex flex-col gap-2">
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-tighter">Current Over History</span>
                <div id="v-over-history" class="flex gap-1 overflow-x-auto py-1"></div>
            </div>
            <div class="p-10 flex-grow flex flex-col items-center justify-center text-center space-y-4">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center"><span class="w-3 h-3 bg-green-500 rounded-full animate-ping"></span></div>
                <p class="text-gray-500 font-medium">Watching Live Updates...</p>
                <button onclick="stopWatching()" class="mt-6 px-6 py-2 border border-gray-300 rounded-full text-sm text-gray-600 font-bold hover:bg-gray-50 shadow-sm uppercase">Back to Logs</button>
            </div>
        </div>

        <!-- Scoring Screen -->
        <div id="scoring-screen" class="hidden flex-grow flex flex-col relative">
            <div class="bg-gray-900 text-white p-6 text-center">
                <div class="flex justify-between items-center mb-1">
                    <span id="display-teams" class="text-sm font-medium text-gray-400 uppercase tracking-widest font-bold">Loading...</span>
                    <span id="display-target" class="text-sm text-[#F7631B] font-bold hidden uppercase">TARGET: 0</span>
                </div>
                <div id="start-time-label" class="text-[10px] text-gray-500 mb-2 uppercase tracking-widest font-medium">Started: --:--</div>
                <div class="text-5xl font-black mb-1"><span id="runs">0</span>/<span id="wickets">0</span></div>
                <div class="text-lg text-gray-400 font-bold">Overs: <span id="overs">0.0</span> / <span id="limit">5</span></div>
                <div class="mt-2 text-xs text-gray-500 flex justify-center gap-4 font-bold">
                    <span>CRR: <span id="crr">0.00</span></span>
                    <span id="rrr-container" class="hidden">RRR: <span id="rrr">0.00</span></span>
                </div>
            </div>

            <!-- Scorer Break Overlay -->
            <div id="break-overlay" class="hidden absolute inset-0 z-20 break-overlay flex flex-col items-center justify-center text-white text-center p-6">
                <div class="text-5xl mb-4">‚è∏Ô∏è</div>
                <h3 class="text-2xl font-black uppercase tracking-tighter">Match Paused</h3>
                <p class="text-sm text-gray-300 mt-2 mb-8">Scoring is disabled during break.</p>
                <div class="flex flex-col gap-3 w-full max-w-[200px]">
                    <button onclick="toggleBreak()" class="w-full bg-brand-primary text-white font-bold py-4 rounded-xl shadow-xl uppercase tracking-widest animate-pulse">
                        Resume Play
                    </button>
                    <button onclick="abandonMatch()" class="w-full bg-gray-700 text-gray-300 font-bold py-3 rounded-xl uppercase text-xs">
                        Abandon Match
                    </button>
                </div>
            </div>

            <div class="p-3 bg-gray-200 border-b flex items-center gap-2 overflow-x-auto">
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-tight">This Over:</span>
                <div id="over-history" class="flex gap-1"></div>
            </div>
            <div class="p-4 grid grid-cols-4 gap-3 bg-white flex-grow">
                <button onclick="addScore(0)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">0</button>
                <button onclick="addScore(1)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">1</button>
                <button onclick="addScore(2)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">2</button>
                <button onclick="addScore(3)" class="col-span-1 bg-gray-100 hover:bg-gray-200 h-16 rounded-lg font-bold text-xl border-b-4 border-gray-300">3</button>
                <button onclick="addScore(4)" class="col-span-2 bg-orange-50 text-[#F7631B] border-b-4 border-orange-200 hover:bg-orange-100 h-16 rounded-lg font-black text-2xl transition-all">4</button>
                <button onclick="addScore(6)" class="col-span-2 bg-[#F7631B] text-white hover:opacity-90 h-16 rounded-lg font-black text-2xl border-b-4 border-orange-800 transition-all">6</button>
                <button onclick="addExtra('WD')" class="col-span-2 bg-gray-50 text-gray-700 hover:bg-gray-100 h-16 rounded-lg font-bold border-b-4 border-gray-200 text-lg">WIDE (+1)</button>
                <button onclick="addExtra('NB')" class="col-span-2 bg-gray-50 text-gray-700 hover:bg-gray-100 h-16 rounded-lg font-bold border-b-4 border-gray-200 text-lg">NO BALL (+1)</button>
                <button onclick="addWicket()" class="col-span-4 bg-red-600 text-white hover:bg-red-700 h-16 rounded-lg font-black text-xl shadow-lg uppercase tracking-widest active:scale-95 transition-all">Wicket!</button>
            </div>
            <div class="p-4 bg-gray-50 flex items-center gap-2">
                <button onclick="undoLast()" class="flex-1 py-3 text-[10px] font-bold text-gray-500 border rounded-lg bg-white hover:bg-gray-100 uppercase transition-all shadow-sm">Undo</button>
                <button onclick="toggleBreak()" class="flex-1 py-3 text-[10px] font-bold text-blue-600 border border-blue-100 rounded-lg bg-white hover:bg-blue-50 uppercase transition-all shadow-sm">Break</button>
                <button onclick="redoLast()" class="flex-1 py-3 text-[10px] font-bold text-[#F7631B] border border-orange-100 rounded-lg bg-white hover:bg-orange-50 uppercase transition-all shadow-sm">Redo</button>
                <div id="save-loader" class="hidden shrink-0"><div class="loader"></div></div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="hidden p-8 text-center flex-grow flex flex-col justify-center">
            <div id="result-emoji" class="text-6xl mb-4">üèÜ</div>
            <h2 id="result-header" class="text-2xl font-black text-gray-800 mb-2 uppercase">Match Finished!</h2>
            <p id="winner-text" class="text-xl font-bold text-[#F7631B] mb-6"></p>
            <div id="final-stats" class="bg-gray-100 p-4 rounded-lg mb-8 text-left space-y-2 text-sm"></div>
            <button onclick="location.reload()" class="w-full bg-brand-primary text-white py-4 rounded-xl font-bold uppercase shadow-lg transition-transform active:scale-95">New Match</button>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[100] flex flex-col gap-2 w-full max-w-xs px-4 pointer-events-none"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBFBAcdUrHyfWGZEjxi0d1JhGHskqBKD3I",
            authDomain: "cricket-17e2d.firebaseapp.com",
            databaseURL: "https://cricket-17e2d-default-rtdb.firebaseio.com",
            projectId: "cricket-17e2d",
            storageBucket: "cricket-17e2d.firebasestorage.app",
            messagingSenderId: "346710609466",
            appId: "1:346710609466:web:a7f4d214c999767474af03"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "cricket-mgcub-v1"; 

        let user = null;
        let currentMatchId = null;
        let unsubscribeMatch = null;
        let unsubscribeHistory = null; 
        let activeMatchData = null; 

        let match = {
            battingTeam: "", bowlingTeam: "", maxOvers: 5,
            innings: 1, target: null, runs: 0, wickets: 0,
            balls: 0, history: [], redoStack: [], overHistory: [],
            startTime: null, endTime: null, isOnBreak: false,
            isAbandoned: false
        };

        // --- Toast System (Replaces alert) ---
        window.showToast = function(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                error: 'bg-red-600',
                success: 'bg-green-600',
                info: 'bg-gray-800',
                warning: 'bg-orange-500'
            };

            toast.className = `${colors[type]} text-white px-4 py-3 rounded-xl shadow-2xl text-xs font-bold flex items-center justify-center text-center pointer-events-auto toast-enter`;
            toast.innerText = message;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('toast-active'), 10);
            
            setTimeout(() => {
                toast.classList.replace('toast-active', 'toast-exit');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        };

        const initAuth = async () => {
            try {
                const cred = await signInAnonymously(auth);
                user = cred.user;
                checkForActiveMatch();
            } catch (err) { 
                showToast("Auth Failed: " + err.message, "error"); 
            }
        };
        initAuth();

        const setupScreen = document.getElementById('setup-screen');
        const scoringScreen = document.getElementById('scoring-screen');
        const historyScreen = document.getElementById('history-screen');
        const resultScreen = document.getElementById('result-screen');
        const viewerScreen = document.getElementById('viewer-screen');
        const syncStatus = document.getElementById('sync-status');
        const backBtn = document.getElementById('global-back-btn');
        const resumeContainer = document.getElementById('resume-container');
        const resumeInfo = document.getElementById('resume-match-info');
        const breakOverlay = document.getElementById('break-overlay');

        async function checkForActiveMatch() {
            if (!user) return;
            try {
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
                const querySnapshot = await getDocs(q);
                const matches = [];
                querySnapshot.forEach(doc => matches.push({id: doc.id, ...doc.data()}));
                const active = matches.find(m => m.scorerId === user.uid && m.status !== "Finished" && m.status !== "Abandoned");
                if (active) {
                    activeMatchData = active;
                    resumeInfo.innerText = `${active.battingTeam} vs ${active.bowlingTeam}`;
                    resumeContainer.classList.remove('hidden');
                } else {
                    resumeContainer.classList.add('hidden');
                }
            } catch (err) { 
                console.warn("Match recovery silent failure"); 
            }
        }

        window.resumeMatch = function() {
            if (!activeMatchData) return;
            currentMatchId = activeMatchData.id;
            match = {
                battingTeam: activeMatchData.battingTeam,
                bowlingTeam: activeMatchData.bowlingTeam,
                maxOvers: activeMatchData.maxOvers,
                innings: activeMatchData.innings,
                target: activeMatchData.target,
                runs: activeMatchData.runs,
                wickets: activeMatchData.wickets,
                balls: activeMatchData.balls,
                history: activeMatchData.history || [],
                redoStack: activeMatchData.redoStack || [],
                overHistory: activeMatchData.overHistory || [],
                startTime: activeMatchData.startTime || null,
                endTime: activeMatchData.endTime || null,
                isOnBreak: activeMatchData.isOnBreak || false,
                isAbandoned: activeMatchData.isAbandoned || false
            };
            setupScreen.classList.add('hidden');
            scoringScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            resumeContainer.classList.add('hidden');
            updateDisplay();
            showToast("Match Resumed Successfully", "success");
        };

        window.toggleBreak = async function() {
            match.isOnBreak = !match.isOnBreak;
            updateDisplay();
            await syncToCloud();
            showToast(match.isOnBreak ? "Break Started" : "Play Resumed", "info");
        };

        window.abandonMatch = async function() {
            if (confirm("Abandon this match? Logs will show 'No Result'.")) {
                match.isAbandoned = true;
                match.isOnBreak = false;
                match.endTime = new Date().toISOString();
                
                scoringScreen.classList.add('hidden');
                resultScreen.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                
                document.getElementById('result-emoji').innerText = "‚òÅÔ∏è";
                document.getElementById('result-header').innerText = "Match Abandoned";
                document.getElementById('winner-text').innerText = "No Result";
                document.getElementById('winner-text').className = "text-xl font-bold text-gray-500 mb-6";
                
                const sTime = match.startTime ? new Date(match.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                const eTime = match.endTime ? new Date(match.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';

                document.getElementById('final-stats').innerHTML = `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-[10px] uppercase text-gray-400 font-bold">Started</p>
                            <p class="text-sm font-bold text-gray-700">${sTime}</p>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <p class="text-[10px] uppercase text-gray-400 font-bold">Ended</p>
                            <p class="text-sm font-bold text-gray-700">${eTime}</p>
                        </div>
                    </div>
                    <p>The match was called off before completion.</p>
                `;
                await syncToCloud();
                showToast("Match has been Abandoned", "warning");
            }
        };

        window.handleGlobalBack = function() {
            if (!scoringScreen.classList.contains('hidden')) {
                if (confirm("Exit scoring dashboard? Progress is safe in the cloud.")) {
                    resetAppState();
                    scoringScreen.classList.add('hidden');
                    setupScreen.classList.remove('hidden');
                    backBtn.classList.add('hidden');
                    checkForActiveMatch();
                }
            } else if (!historyScreen.classList.contains('hidden')) {
                hideHistory();
            } else if (!viewerScreen.classList.contains('hidden')) {
                stopWatching();
            } else if (!resultScreen.classList.contains('hidden')) {
                location.reload();
            }
        };

        function resetAppState() {
            currentMatchId = null;
            match = {
                battingTeam: "", bowlingTeam: "", maxOvers: 5,
                innings: 1, target: null, runs: 0, wickets: 0,
                balls: 0, history: [], redoStack: [], overHistory: [],
                startTime: null, endTime: null, isOnBreak: false,
                isAbandoned: false
            };
        }

        window.startMatch = async function() {
            const bTeam = document.getElementById('batting-team').value;
            const boTeam = document.getElementById('bowling-team').value;
            if(bTeam === boTeam) { 
                showToast("Cannot select same team for both!", "error"); 
                return; 
            }
            match.battingTeam = bTeam; match.bowlingTeam = boTeam;
            match.maxOvers = parseInt(document.getElementById('max-overs').value);
            match.startTime = new Date().toISOString();
            currentMatchId = "match_" + Date.now();
            setupScreen.classList.add('hidden');
            scoringScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            resumeContainer.classList.add('hidden');
            await syncToCloud();
            updateDisplay();
            showToast("Match Started!", "success");
        };

        async function syncToCloud() {
            if (!user || !currentMatchId) return;
            document.getElementById('save-loader').classList.remove('hidden');
            syncStatus.classList.replace('bg-green-400', 'bg-yellow-400');
            try {
                let statusStr = "Live";
                if (match.isAbandoned) statusStr = "Abandoned";
                else if (!resultScreen.classList.contains('hidden')) statusStr = "Finished";
                else if (match.isOnBreak) statusStr = "On Break";

                const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', currentMatchId);
                await setDoc(matchRef, {
                    ...match, lastUpdated: serverTimestamp(), scorerId: user.uid,
                    status: statusStr
                });
                syncStatus.classList.replace('bg-yellow-400', 'bg-green-400');
            } catch (err) {
                syncStatus.classList.replace('bg-yellow-400', 'bg-red-500');
                showToast("Cloud sync failed. Check connection.", "warning");
            } finally {
                document.getElementById('save-loader').classList.add('hidden');
            }
        }

        window.addScore = async function(r) {
            if (match.isOnBreak || match.isAbandoned) return;
            saveState();
            match.runs += r; match.balls++; match.overHistory.push(r);
            checkInningsStatus(); updateDisplay(); await syncToCloud();
        };

        window.addExtra = async function(type) {
            if (match.isOnBreak || match.isAbandoned) return;
            saveState();
            match.runs += 1; match.overHistory.push(type);
            updateDisplay(); await syncToCloud();
        };

        window.addWicket = async function() {
            if (match.isOnBreak || match.isAbandoned) return;
            saveState();
            match.wickets++; match.balls++; match.overHistory.push('W');
            checkInningsStatus(); updateDisplay(); await syncToCloud();
        };

        function checkInningsStatus() {
            const totalBalls = match.maxOvers * 6;
            if (match.innings === 1) {
                if (match.wickets >= 10 || match.balls >= totalBalls) switchToSecondInnings();
            } else {
                if (match.runs >= match.target) endMatch(match.battingTeam + " wins!");
                else if (match.wickets >= 10 || match.balls >= totalBalls) {
                    if (match.runs === match.target - 1) endMatch("It's a Draw!");
                    else endMatch(match.bowlingTeam + " wins!");
                }
            }
        }

        function switchToSecondInnings() {
            showToast(`First Innings Finished! Target: ${match.runs + 1}`, "warning");
            const prevRuns = match.runs; const temp = match.battingTeam;
            match.battingTeam = match.bowlingTeam; match.bowlingTeam = temp;
            match.target = prevRuns + 1; match.runs = 0; match.wickets = 0; match.balls = 0;
            match.innings = 2; match.overHistory = []; match.history = []; match.redoStack = [];
            document.getElementById('display-target').classList.remove('hidden');
            document.getElementById('rrr-container').classList.remove('hidden');
        }

        function endMatch(winner) {
            match.endTime = new Date().toISOString();
            match.isOnBreak = false;
            scoringScreen.classList.add('hidden'); resultScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            document.getElementById('winner-text').innerText = winner;
            document.getElementById('result-emoji').innerText = "üèÜ";
            document.getElementById('result-header').innerText = "Match Finished!";
            document.getElementById('winner-text').className = "text-xl font-bold text-[#F7631B] mb-6";
            
            const sTime = match.startTime ? new Date(match.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
            const eTime = match.endTime ? new Date(match.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';

            document.getElementById('final-stats').innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="bg-gray-50 p-2 rounded">
                        <p class="text-[10px] uppercase text-gray-400 font-bold">Start</p>
                        <p class="text-sm font-bold text-gray-700">${sTime}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded">
                        <p class="text-[10px] uppercase text-gray-400 font-bold">End</p>
                        <p class="text-sm font-bold text-gray-700">${eTime}</p>
                    </div>
                </div>
                <p class="font-bold">Final Score: ${match.runs}/${match.wickets} in ${formatOvers(match.balls)} overs</p>
            `;
            syncToCloud();
            showToast("Match Finished - Summary Generated", "success");
        }

        function updateDisplay() {
            document.getElementById('display-teams').innerText = `${match.battingTeam} vs ${match.bowlingTeam}`;
            document.getElementById('runs').innerText = match.runs;
            document.getElementById('wickets').innerText = match.wickets;
            document.getElementById('overs').innerText = formatOvers(match.balls);
            document.getElementById('limit').innerText = match.maxOvers;
            
            if (match.isOnBreak) breakOverlay.classList.remove('hidden');
            else breakOverlay.classList.add('hidden');

            if (match.startTime) {
                const time = new Date(match.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                document.getElementById('start-time-label').innerText = `Started: ${time}`;
            }

            if (match.target) {
                document.getElementById('display-target').innerText = `TARGET: ${match.target}`;
                document.getElementById('display-target').classList.remove('hidden');
                document.getElementById('rrr-container').classList.remove('hidden');
                const ballsLeft = (match.maxOvers * 6) - match.balls;
                const rrr = ballsLeft > 0 ? ((match.target - match.runs) / (ballsLeft / 6)).toFixed(2) : "0.00";
                document.getElementById('rrr').innerText = rrr;
            } else {
                document.getElementById('display-target').classList.add('hidden');
                document.getElementById('rrr-container').classList.add('hidden');
            }
            const crr = match.balls > 0 ? (match.runs / (match.balls / 6)).toFixed(2) : "0.00";
            document.getElementById('crr').innerText = crr;
            renderBalls(document.getElementById('over-history'), match.balls, match.overHistory);
        }

        function renderBalls(container, totalBalls, ballsList) {
            container.innerHTML = ''; let currentOverBalls = [];
            if (totalBalls > 0 || ballsList.length > 0) {
                const legalBallsToSkip = Math.floor((totalBalls - 0.1) / 6) * 6;
                let legalCount = 0; let startIndex = 0;
                for (let i = 0; i < ballsList.length; i++) {
                    if (legalCount >= legalBallsToSkip) { startIndex = i; break; }
                    if (ballsList[i] !== 'WD' && ballsList[i] !== 'NB') legalCount++;
                }
                currentOverBalls = ballsList.slice(startIndex);
            }
            currentOverBalls.forEach(ball => {
                const span = document.createElement('span');
                span.className = 'ball-dot ' + getBallColor(ball);
                span.innerText = ball; container.appendChild(span);
            });
        }

        function getBallColor(val) {
            if (val === 4) return 'bg-orange-100 text-[#F7631B] border-orange-300';
            if (val === 6) return 'bg-[#F7631B] text-white border-orange-800';
            if (val === 'W') return 'bg-red-500 text-white border-red-600';
            if (val === 'WD' || val === 'NB') return 'bg-yellow-400 text-black border-yellow-500';
            return 'bg-white text-gray-800 border-gray-300';
        }

        function formatOvers(balls) { return `${Math.floor(balls / 6)}.${balls % 6}`; }

        function saveState() {
            match.history.push(JSON.stringify({
                runs: match.runs, wickets: match.wickets, balls: match.balls, overHistory: [...match.overHistory]
            }));
            if (match.history.length > 30) match.history.shift();
            match.redoStack = [];
        }

        window.undoLast = async function() {
            if (match.history.length === 0 || match.isOnBreak) return;
            match.redoStack.push(JSON.stringify({
                runs: match.runs, wickets: match.wickets, balls: match.balls, overHistory: [...match.overHistory]
            }));
            const prevState = JSON.parse(match.history.pop());
            match.runs = prevState.runs; match.wickets = prevState.wickets;
            match.balls = prevState.balls; match.overHistory = prevState.overHistory;
            updateDisplay(); await syncToCloud();
            showToast("Action Undone", "info");
        };

        window.redoLast = async function() {
            if (match.redoStack.length === 0 || match.isOnBreak) return;
            match.history.push(JSON.stringify({
                runs: match.runs, wickets: match.wickets, balls: match.balls, overHistory: [...match.overHistory]
            }));
            const nextState = JSON.parse(match.redoStack.pop());
            match.runs = nextState.runs; match.wickets = nextState.wickets;
            match.balls = nextState.balls; match.overHistory = nextState.overHistory;
            updateDisplay(); await syncToCloud();
            showToast("Action Redone", "info");
        };

        window.showHistory = function() {
            setupScreen.classList.add('hidden'); 
            historyScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden'); 
            resumeContainer.classList.add('hidden');
            const list = document.getElementById('history-list');
            list.innerHTML = '<div class="text-center py-10 text-xs text-gray-400">Connecting to Tournament Stream...</div>';
            
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'matches');
            unsubscribeHistory = onSnapshot(q, (querySnapshot) => {
                let matches = [];
                querySnapshot.forEach(doc => matches.push({id: doc.id, ...doc.data()}));
                matches.sort((a, b) => (b.lastUpdated?.seconds || 0) - (a.lastUpdated?.seconds || 0));
                
                if (matches.length === 0) { 
                    list.innerHTML = '<div class="text-center py-10 text-gray-400">No match records found.</div>'; 
                    return; 
                }

                list.innerHTML = matches.map(m => {
                    const sT = m.startTime ? new Date(m.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--';
                    const eT = m.endTime ? new Date(m.endTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                    let sCol = 'bg-gray-100 text-gray-600';
                    if (m.status === 'Live') sCol = 'bg-green-100 text-green-700 animate-pulse';
                    else if (m.status === 'On Break') sCol = 'bg-blue-100 text-blue-700';
                    else if (m.status === 'Abandoned') sCol = 'bg-red-50 text-red-400';

                    return `
                        <div class="bg-white border rounded-xl p-4 shadow-sm border-l-4 border-l-[#F7631B]">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex flex-col">
                                    <span class="text-[10px] font-bold text-gray-400 uppercase">${m.startTime ? new Date(m.startTime).toLocaleDateString([], {month:'short', day:'numeric'}) : 'Today'}</span>
                                    <span class="text-[9px] text-gray-500">${sT} ${eT ? ' - ' + eT : ''}</span>
                                </div>
                                <span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${sCol}">${m.status}</span>
                            </div>
                            <div class="flex justify-between items-center mb-3">
                                <div class="font-bold text-gray-800">${m.battingTeam} <span class="text-gray-400 text-[10px] lowercase">vs</span> ${m.bowlingTeam}</div>
                                <div class="text-right">
                                    <p class="text-xl font-black text-gray-900">${m.runs}/${m.wickets}</p>
                                    <p class="text-[10px] text-gray-500">${formatOvers(m.balls)} Overs</p>
                                </div>
                            </div>
                            <button onclick="startWatching('${m.id}')" class="w-full py-2 text-xs font-bold text-brand-primary border border-orange-100 bg-orange-50 rounded-lg uppercase tracking-tight">View Live Score</button>
                        </div>
                    `;
                }).join('');
            }, (err) => {
                showToast("Stream lost. Please back and return.", "error");
            });
        };

        window.startWatching = function(matchId) {
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeHistory = null;
            historyScreen.classList.add('hidden');
            setupScreen.classList.add('hidden'); 
            viewerScreen.classList.remove('hidden');
            backBtn.classList.remove('hidden');
            
            const matchRef = doc(db, 'artifacts', appId, 'public', 'data', 'matches', matchId);
            unsubscribeMatch = onSnapshot(matchRef, (docSnap) => {
                if (docSnap.exists()) updateViewerUI(docSnap.data());
                else { 
                    showToast("This match data was removed.", "error"); 
                    stopWatching(); 
                }
            }, (err) => {
                showToast("Lost connection to match.", "error");
                stopWatching();
            });
        };

        function updateViewerUI(data) {
            document.getElementById('v-display-teams').innerText = `${data.battingTeam} vs ${data.bowlingTeam}`;
            document.getElementById('v-runs').innerText = data.runs; document.getElementById('v-wickets').innerText = data.wickets;
            document.getElementById('v-overs').innerText = formatOvers(data.balls); document.getElementById('v-limit').innerText = data.maxOvers;
            
            const vB = document.getElementById('v-break-overlay');
            if (data.status === "On Break" || data.status === "Abandoned") {
                vB.classList.remove('hidden');
                if (data.status === "Abandoned") {
                    document.getElementById('v-overlay-icon').innerText = "‚òÅÔ∏è";
                    document.getElementById('v-overlay-title').innerText = "Abandoned";
                    document.getElementById('v-overlay-desc').innerText = "This match was called off.";
                } else {
                    document.getElementById('v-overlay-icon').innerText = "‚òï";
                    document.getElementById('v-overlay-title').innerText = "Break Time";
                    document.getElementById('v-overlay-desc').innerText = "Play is currently paused.";
                }
            } else vB.classList.add('hidden');

            if (data.startTime) document.getElementById('v-start-time-label').innerText = `Started: ${new Date(data.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
            
            if (data.target) {
                document.getElementById('v-display-target').innerText = `TARGET: ${data.target}`;
                document.getElementById('v-display-target').classList.remove('hidden');
                document.getElementById('v-rrr-box').classList.remove('hidden');
                const bl = (data.maxOvers * 6) - data.balls; 
                const rrr = bl > 0 ? ((data.target - data.runs) / (bl / 6)).toFixed(2) : "0.00";
                document.getElementById('v-rrr').innerText = rrr;
            } else {
                document.getElementById('v-display-target').classList.add('hidden');
                document.getElementById('v-rrr-box').classList.add('hidden');
            }
            document.getElementById('v-crr').innerText = data.balls > 0 ? (data.runs / (data.balls / 6)).toFixed(2) : "0.00";
            renderBalls(document.getElementById('v-over-history'), data.balls, data.overHistory || []);
        }

        window.stopWatching = function() {
            if (unsubscribeMatch) unsubscribeMatch(); unsubscribeMatch = null;
            viewerScreen.classList.add('hidden'); showHistory(); 
            showToast("Returned to logs", "info");
        };

        window.hideHistory = function() { 
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeHistory = null;
            historyScreen.classList.add('hidden'); 
            setupScreen.classList.remove('hidden'); 
            backBtn.classList.add('hidden'); 
            checkForActiveMatch();
        };
    </script>
</body>
</html>
